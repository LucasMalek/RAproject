<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/prototipohome.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <title>Document</title>
</head>
<body>
  <div class="maincontainer">
    <div class="topbar">
      <button onclick="location.reload()" id="logotopbar">
        <img src="../static/images/Logotopbar.png">
      </button>
      <button id="menubutton">
          <div class="menuelement"></div>
          <div class="menuelement"></div>
          <div class="menuelement"></div>
      </button>
    </div>
    <div class="tab_container">
      <div id="consult">Consulta</div>
      <div id="results">Resultados</div>
    </div>
    
    <div class="maincontentborder">
      <div id="createtablespace">
        <div id="tabdisplayspace"></div>
      </div>
      <div class="contentcontainer">
        <img src="../static/images/Logo.png" id="logo">
        <div class="db-entry-prompt">Como você deseja entrar com o Banco de Dados?</div>
        <form class="userchoicecontainer">
          <label for="fileInput">Selecionar arquivo .db</label>
          <input type="file" id="fileInput" accept=".db">
          <button onclick="displaycreatetable(1)">Criar banco de dados</button>
        </form>
      </div>
    </div>
  </div>
        <div id="create_table_container">
          <div class="close-create-table-container">
            <input type="text" class="create-table-name" placeholder="Nome da tabela">
            <button id="close-create-table"  title="Fechar a criação do banco de dados" onclick="deletecreatetable(this.parentNode.parentNode)">X</button>
          </div>
          <div id="tab_display" tabnumber = 1 tablename = ''>
            <div class="attribute-input">
                <input type="text" placeholder="Nome do Atributo" class="create_atribute_name">
                <select class="attribute_type">
                    <option selected disabled value="none">Tipo</option>
                    <option value="TEXT">Texto</option>
                    <option value="INT">Número</option>
                    <option value="DATE">Data</option>
                </select>
                <div class="attribute-input_buttons">
                  <button class="add-button" title="Adicionar um novo atributo" onclick="addAttribute(this.parentNode.parentNode.parentNode)">+</button>
                  <button class="remove-button" title="Remover atributo" onclick="removeAttribute(this.parentNode.parentNode)">-</button>
                </div>
            </div>
          <div class="tuple_input">
            <div class="attribute-input_buttons">
              <button class="add-button" title="Acionar nova tupla" onclick="addtuple(this.parentNode.parentNode.parentNode)">+</button>
              <button class="remove-button"  title="Remover tupla" onclick="removetuple(this.parentNode.parentNode)">-</button>
            </div>
            <input class="create_tuple_element" placeholder="Digite o valor">
          </div>
          </div>
          <div class="buttons_container_for_table_container"> 
            <button class="create_table_delete_button" onclick="deletetable_increatetable(this.parentNode.parentNode)">
              <i class="fas fa-trash icon-trash"></i>
              Deletar tabela
            </button>
            <button class="create-db-button" onclick="sendbdtocreate('createdbfile')">
              <i class="fas fa-chevron-right icon-arrow"></i>Criar BD
            </button>
          </div>
      </div>
      <div id="bd">
        <div class="relation_label">
          Relações
          <div>
            <label class="change_db" title="Trocar banco de dados">
              <i class="fas fa-sync-alt"></i>
              <input type="file" id="change_db_input" accept=".db">
          </label>
          </div>
        </div>
      </div>
      <div class="consult_environment">
        <div class="keyboard">
          <button onclick='operator_impression("\u2190")'>&#8592;</button>
          <button onclick='operator_impression("\u03C3")'>&sigma;</button>
          <button onclick='operator_impression("\u03C0")'>&Pi;</button>
          <button onclick='operator_impression("\u03C1")'>&rho;</button>
          <button onclick='operator_impression("\u222A")'>&Union;</button>
          <button onclick='operator_impression("\u2212")'>-</button>
          <button onclick='operator_impression("\u2229")'>∩</button>
          <button onclick='operator_impression("\u2715")'>×</button>
          <button onclick='operator_impression("⋈")'>⋈</button>
          <button onclick='operator_impression("⋈θ")'>⋈θ</button>
          <button onclick='operator_impression("\u00F7")'>÷</button>
      </div>
      <form method="post" id="consult_form">
          <div class="consult_interface"></div>
          <div class="consultform_buttons_container">
            <span class="consult_observation">Obs: <br>1. Se os valores dos atributos nas condições das operações for uma string, 
              <br>é preciso colocar o valor entre aspas simples. Ex: Atr = 'Diego'. 
              <br>2. Para inserir uma nova linha a partir da primeira linha, utilize o operador 'Atribuição'.</span>
            <button onclick="deletealloperators()"  type="button" class="create-db-button">
              <i class="fas fa-trash icon-trash" style="margin-right: 0.8rem; color: red;"></i>Apagar todos os operadores
            </button>
            <button type="submit">
              <i class="fas fa-chevron-right icon-arrow" style="margin-right: 0.8rem; color: white;"></i>Consultar
            </button>
          </div>
      </form>
      </div>
      <div class="resultcontainer">
        <div id="historic">
          <div class="titlecontainer">
            Histórico
          </div>
        </div>
        <div id="result">
          <div class="titlecontainer">
            Resultado
          </div>
          <h1>O resultado de suas consultas apareceram aqui</h1>
        </div>
      </div>
  <script>
    const form = document.querySelector('.userchoicecontainer');

document.getElementById('fileInput').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const fileName = file.name.toLowerCase();
            if (fileName.endsWith('.db')) {
                form.dispatchEvent(new Event('submit'));
            } else {
                alert('Por favor, selecione um arquivo com a extensão .db');
            }
        }
    });

form.addEventListener('submit', function(event) {
        event.preventDefault();
        const fileInput = document.getElementById('fileInput');
        const selectedFile = fileInput.files[0];
    
        if (!selectedFile) {
            return;
        }
        const loadercircle = document.createElement('div');
        loadercircle.className = 'create_db_loadercircle';
        loadercircle.style.width = '2rem';
        loadercircle.style.height = '2rem';
        loadercircle.style.marginTop = '0';
        loadercircle.style.position = 'absolute';
        loadercircle.style.top = '85%';
        loadercircle.style.left = '48%';
        document.querySelector('.contentcontainer').appendChild(loadercircle);
        let formData = new FormData();
        formData.append('file', selectedFile);
    
        fetch('/loadfile', {
            method: 'POST',
            body: formData
        }).then(response => {
            if (!response.ok) {
                throw new Error('Erro na requisição');
            } else {
                return response.json();
            }
        }).then(db => {
            loadercircle.remove();
            initializesystem(db); 
        }).catch(error => {
            console.error('Erro ao carregar o arquivo:', error);
        });
    });
    
function initializesystem(db) {
      const replacementContainer = document.createElement('div');
      replacementContainer.setAttribute('class', 'consultcontainer');
      const contentContainer = document.querySelector('.contentcontainer');
      const containerborder = document.querySelector('.maincontentborder');
      
      const consult_environment = document.querySelector('.consult_environment');
      const bd_area = document.querySelector('#bd');
      const resultcontainer = document.querySelector('.resultcontainer')

      contentContainer.classList.add('content-fading-out');
            contentContainer.addEventListener('transitionend', () => {
            containerborder.removeChild(contentContainer);
            bd_area.style.display = 'flex';
            Array.from(bd_area.children).forEach(element => {
              element.style.display = 'flex';
            })
            consult_environment.style.display = 'flex';
            Array.from(consult_environment.children).forEach(element => {
            element.style.display = 'flex';
            })
            replacementContainer.appendChild(bd_area)
            replacementContainer.appendChild(consult_environment)
            containerborder.appendChild(replacementContainer);
            replacementContainer.classList.add('content-fading-in')
            containerborder.style.backgroundColor = 'white';
            containerborder.style.opacity = '95%';
            printdbtables(db, 'alltables')
            let tab = document.querySelector('.tab_container')
            tab.style.display = 'flex'
            tab.style.height = '3.6rem';
            tab.style.top = '1.6rem';
            Array.from(tab.children).forEach(element => {
              element.style.display = 'flex';
            })
            containerborder.style.borderTopLeftRadius = '0';
            containerborder.appendChild(resultcontainer);
            tablistener()
            const containerfade = document.createElement('div');
            containerfade.className = 'containerfade_maininterface';
            document.querySelector('.maincontainer').appendChild(containerfade);
            });
            change_db_listener();
          
    }

function change_db_listener() {
      const inputElement = document.getElementById('change_db_input');
      
      inputElement.removeEventListener('change', handleChangeDB);
      
      inputElement.addEventListener('change', handleChangeDB);
  }
  
function handleChangeDB(event) {
    const file = event.target.files[0];
    if (file) {
        const fileName = file.name.toLowerCase();
        if (fileName.endsWith('.db')) {
            const db_container = document.querySelector('#bd');
            const loadercircle = document.createElement('div');
            loadercircle.className = 'create_db_loadercircle';
            loadercircle.style.width = '2rem';
            loadercircle.style.height = '2rem';
            loadercircle.style.position = 'absolute';
            loadercircle.style.top = '17rem';
            loadercircle.style.left = '15rem';
            
            let formData = new FormData();
            formData.append('file', file);
            db_container.querySelectorAll('.table_container').forEach(old_table => {
              old_table.remove();
            });
            db_container.appendChild(loadercircle);
            fetch('/loadfile', {
                method: 'POST',
                body: formData
            }).then(response => {
                if (!response.ok) {
                    throw new Error('Erro na requisição');
                } else {
                    return response.json();
                }
            }).then(db => {
                
                printdbtables(db, 'alltables');
                
                db_container.querySelectorAll('.table_container').forEach(newtables => {
                    newtables.style.opacity = 0;
                });

                setTimeout(() => {
                    db_container.querySelectorAll('.table_container').forEach(newtables => {
                        newtables.style.opacity = 1;
                    });
                }, 100);
                loadercircle.remove(); 
                event.target.value = ''; 
            }).catch(error => {
                console.error('Erro ao carregar o arquivo:', error);
                event.target.value = ''; 
            });
        } else {
            alert('Por favor, selecione um arquivo com a extensão .db');
            event.target.value = ''; 
        }
    }
}

    let last_tab = "consult";
    let last_tab_create_table = 1;
    let operators = [];
    let selectedRelation = null
    let click_flag = false
    let createtableclone;
    let tablenames = [];
    let historic_results = [];
    let createtablecompleteclone;

document.addEventListener('DOMContentLoaded', () => {
         createtable = document.querySelector('#create_table_container')
         createtablecompleteclone = createtable.cloneNode(true);
         createtable.style.display = 'flex';
         createtableclone = document.querySelector('#tab_display').cloneNode(true);
         createtable.style.display = 'none';
  });

function addAttribute(fathercontainer, namevalue, typevalue, tuplevalue) {
            const attributeNameInput = document.createElement('input');
            attributeNameInput.type = 'text';
            attributeNameInput.placeholder = 'Nome do Atributo';
            attributeNameInput.className = "create_atribute_name"
            attributeNameInput.style.marginLeft = "0.5rem";
            let input_tuples
            if(!tuplevalue) {
              input_tuples =  fathercontainer.querySelectorAll('.tuple_input');
            }else {
              input_tuples = fathercontainer.querySelector('.tuple_input');
            }
            const attributeTypeSelect = document.createElement('select');
            attributeTypeSelect.className = "attribute_type";
            attributeTypeSelect.options[attributeTypeSelect.options.length] = new Option('Tipo', 'Tipo');
            attributeTypeSelect.options[attributeTypeSelect.options.length] = new Option('Texto', 'TEXT');
            attributeTypeSelect.options[attributeTypeSelect.options.length] = new Option('Número', 'INT');
            attributeTypeSelect.options[attributeTypeSelect.options.length] = new Option('Data', 'DATE');

            if(namevalue) {
              attributeNameInput.value = namevalue
              for(i = 0; i < attributeTypeSelect.length; i++) {
                let option = attributeTypeSelect.options[i]
                if(typevalue == option.value) {
                  option.selected = true;
                  break; 
                }
              }
            }
            const attributeButtons = document.createElement('div');
            attributeButtons.className = 'attribute-input_buttons';
            const addButton = document.createElement('button');
            addButton.className = 'add-button';
            addButton.innerText = '+';
            addButton.title = 'Adicionar novo atributo';
            const removeButton = document.createElement('button');
            removeButton.className = 'remove-button';
            removeButton.innerText = '-';
            removeButton.title = 'Remover atributo';
            attributeButtons.appendChild(addButton);
            attributeButtons.appendChild(removeButton);
            container = fathercontainer.querySelector('.attribute-input');
            const selects = container.querySelectorAll('.attribute_type');
            container.querySelector('.attribute-input_buttons').remove();
            container.appendChild(attributeNameInput);
            container.appendChild(attributeTypeSelect);
            container.appendChild(attributeButtons);

            if(!tuplevalue) {
              input_tuples.forEach((element) => {
                let newvaluetuple =  document.createElement('input');
                newvaluetuple.className = "create_tuple_element";
                newvaluetuple.style.borderTopLeftRadius = '0px';
                newvaluetuple.style.borderBottomLeftRadius = '0px';
                newvaluetuple.style.marginLeft = '0.5rem';
                newvaluetuple.placeholder = 'Digite o valor';
                lastchild = element.querySelector('.create_tuple_element:last-child');
                lastchild.style.borderBottomRightRadius = '0px';
                lastchild.style.borderTopRightRadius = '0px';
                element.appendChild(newvaluetuple)
              })
            }else {
                let newvaluetuple =  document.createElement('input');
                newvaluetuple.className = "create_tuple_element";
                newvaluetuple.style.marginLeft = '0.5rem';
                newvaluetuple.value = tuplevalue;
                lastchild = input_tuples.querySelector('.create_tuple_element:last-child');
                input_tuples.appendChild(newvaluetuple)    
            }
            
            addButton.onclick = function() {
                addAttribute(fathercontainer);
            };
            removeButton.onclick = function() {
              removeAttribute(container);
            }   

        }

function addtuple(container, values) {
    const allTupleInputs = container.querySelectorAll('.tuple_input');
    const lastTupleInput = allTupleInputs[allTupleInputs.length - 1];
    const buttonscontainer = lastTupleInput.querySelector('.attribute-input_buttons');

    if (buttonscontainer) {
        buttonscontainer.remove();
    }

    lastTupleInput.style.paddingLeft = '2.8rem';
    const quantityofvalues = container.querySelector('.tuple_input').querySelectorAll('.create_tuple_element').length;
    const element = document.createElement('div');
    element.className = 'tuple_input';

    const attributeButtons = document.createElement('div');
    attributeButtons.className = 'attribute-input_buttons';
    const addButton = document.createElement('button');
    addButton.className = 'add-button';
    addButton.innerText = '+';
    addButton.title = 'Adicionar nova tupla';
    const removeButton = document.createElement('button');
    removeButton.className = 'remove-button';
    removeButton.innerText = '-';
    removeButton.title = 'Remover tupla';
    attributeButtons.appendChild(addButton);
    attributeButtons.appendChild(removeButton);

    addButton.onclick = function() {
      addtuple(container)
    };

    removeButton.onclick = function() {
      removetuple(element);
    }

    element.appendChild(attributeButtons);

    for (let i = 0; i < quantityofvalues; i++) {
        let newvaluetuple = document.createElement('input');
        newvaluetuple.className = "create_tuple_element";
        newvaluetuple.placeholder = 'Digite o valor';
        if(values) {
          newvaluetuple.value = values[i]
        }
        if(i >= 1) {
          newvaluetuple.style.marginLeft = '0.5rem';
        }
        element.appendChild(newvaluetuple);
    }
    container.appendChild(element);
}

function removeAttribute(attributefather) {
  const buttons_container = attributefather.querySelector('.attribute-input_buttons');
  const copy = buttons_container.cloneNode(true);
  buttons_container.remove();
  let lastattributetype = attributefather.querySelectorAll('.attribute_type');
  lastattributetype = lastattributetype[lastattributetype.length - 1];
  lastattributetype.remove();
  let lastattributename = attributefather.querySelectorAll('.create_atribute_name');
  lastattributename = lastattributename[lastattributename.length - 1];
  lastattributename.remove();
  attributefather.appendChild(copy);

  const addbutton =  copy.querySelector('.add-button');
  addbutton.title = 'Adicionar um novo atributo';
  const removebutton = copy.querySelector('.remove-button');
  removebutton.title = 'Remover atributo';

  addbutton.onclick = function() {
    addAttribute(attributefather.parentNode);
  }

  removebutton.onclick = function() {
    removeAttribute(attributefather);
  }

  let rows = attributefather.parentNode.querySelectorAll('.tuple_input');
  rows.forEach(row => {
    row.lastElementChild.remove();
  });

}

function removetuple(tupleElement) {
  let previousTuple = tupleElement.previousElementSibling;
  previousTuple.style.padding = '0'
  const buttonscontainer = tupleElement.querySelector('.attribute-input_buttons').cloneNode(true);
  const addButton = buttonscontainer.querySelector('.add-button');
  const removeButton = buttonscontainer.querySelector('.remove-button');
  addButton.title = 'Adicionar nova tupla';
  removeButton.title = 'Remover tupla';

  tupleElement.remove();

  if (previousTuple) {
       previousTuple.insertBefore(buttonscontainer, previousTuple.firstChild);
  }

  addButton.onclick = function() {
    addtuple(previousTuple.parentNode)
  };

  removeButton.onclick = function() {
    removetuple(previousTuple);
  }
}

function deletecreatetable(createtable) {
   let table_tab = document.querySelector('#create_table_tab')
   if(table_tab) {
        table_tab.remove()
   }
   const containerfade = document.querySelector('.containerfade_createtable')
   if(containerfade) {
      containerfade.remove();
   }
   actualcreatetable = document.querySelector('#create_table_container');
   father = actualcreatetable.parentNode;
   newelement = createtablecompleteclone.cloneNode(true);
   father.replaceChild(newelement, actualcreatetable);
   newelement.style.display = 'none';
   document.querySelector('#createtablespace').style.display = 'none';
   con = document.querySelector('.contentcontainer');
   if(con) {
       con.style.display = 'flex';
   }
   
}

function deletealloperators() {
  document.querySelectorAll('.operator-container').forEach(element => {
      element.remove();
  });
  operators = [];
}

function resizeconteinerscreatetable() {
  const tabDisplay = document.getElementById('tab_display');
  const closeCreateTableContainer = document.querySelector('.close-create-table-container');
  const buttonsContainerForTable = document.querySelector('.buttons_container_for_table_container');

  function adjustContainerWidth() {
      const scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      const tabDisplayWidth = tabDisplay.scrollWidth;
      const scrollbarWidth = tabDisplay.offsetWidth - tabDisplay.clientWidth;

      closeCreateTableContainer.style.width = `${tabDisplayWidth - scrollbarWidth}px`;
      closeCreateTableContainer.style.left = `-${scrollLeft}px`;

      buttonsContainerForTable.style.width = `${tabDisplayWidth - scrollbarWidth}px`;
      buttonsContainerForTable.style.left = `-${scrollLeft}px`;
  }

  adjustContainerWidth();

  window.addEventListener('resize', adjustContainerWidth);
  window.addEventListener('scroll', adjustContainerWidth);
}

function displaycreatetable(requisitiontype, clone) {
    
    const maincontainer = document.querySelector('#create_table_container');
    maincontainer.style.display = 'flex';

    const createtablespace = document.querySelector('#createtablespace');
    createtablespace.style.display = 'flex';
    const tabdisplayspace = document.querySelector('#tabdisplayspace');
    tabdisplayspace.style.display = 'flex';

    if(clone) {
      maincontainer.style.display = 'flex';
      let tabdisplay = maincontainer.querySelector('#tab_display');
      maincontainer.replaceChild(clone, tabdisplay);
      maincontainer.style.position = 'absolute';
      maincontainer.style.left = '20%';
      maincontainer.style.top = '20%';
    }

    if(requisitiontype == 1) {
      document.querySelector('.contentcontainer').style.display = 'none';
    let numtabelas = 1;
    let tabcontainer = document.createElement('div');
    tabcontainer.className = 'tab_container';
    tabcontainer.style.display = 'flex';
    tabcontainer.style.height = 'fit-content';
    tabcontainer.style.width = '70rem';
    tabcontainer.style.marginLeft = '2rem';
    tabcontainer.id = 'create_table_tab';
    createtablespace.insertBefore(tabcontainer, tabdisplayspace);

    const containerfade = document.createElement('div');
    containerfade.className = 'containerfade_createtable';
    
    tabdisplayspace.appendChild(containerfade);
    tabdisplayspace.appendChild(maincontainer);
    
    let tab = document.createElement('div');
    tab.textContent = `Tabela ${numtabelas}`;
    tab.style.display = 'flex';
    tab.style.width = '6.5rem';
    tab.id = numtabelas;

    let addbutton = document.createElement('BUTTON');
    addbutton.className = 'add-button';
    addbutton.textContent = '+';
    addbutton.style.color = 'white';
    addbutton.style.fontSize = 'x-large';
    addbutton.style.alignSelf = 'center';
    addbutton.style.marginLeft = '1rem';
    addbutton.style.padding = '0.8rem 0.8rem';
    
    addbutton.addEventListener('mouseover', () => {
        addbutton.style.backgroundColor = 'rgba(87, 48, 129, 1)';
    });

    addbutton.addEventListener('mouseout', () => {
        addbutton.style.backgroundColor = 'transparent';
    });

    addbutton.onclick = function() {
        tabcontainer.querySelector('.add-button').remove();
        let newtab = tab.cloneNode(true);
        const buttons_container = maincontainer.querySelector('.buttons_container_for_table_container');
        buttons_container.querySelector('.create_table_delete_button').style.display = 'flex';
        numtabelas = numtabelas + 1;
        newtab.textContent = `Tabela ${numtabelas}`;
        newtab.style.borderTopLeftRadius = '0px';
        newtab.style.borderBottomLeftRadius = '0px';
        newtab.style.marginLeft = '0.2rem';
        newtab.id = numtabelas;
        tabcontainer.appendChild(newtab);
        tabcontainer.appendChild(addbutton);
        let newtabDOM = createtableclone.cloneNode(true);
        newtabDOM.setAttribute('tabnumber', `${numtabelas}`);
        newtabDOM.style.display = 'none';
        maincontainer.appendChild(newtabDOM);
        createtabletablistener();
        updateTabNumbers();
        newtab.click();
        newtab.style.backgroundColor = '#e0463a';
        maincontainer.querySelector('.close-create-table-container').querySelector('.create-table-name').value = '';
        const copy = buttons_container.cloneNode(true);
        buttons_container.remove();
        maincontainer.appendChild(copy);
    };
     tabcontainer.appendChild(tab);
     tabcontainer.appendChild(addbutton);
     createtabletablistener();
     resizeconteinerscreatetable();
    }
    tablenamelistener();
}

function deletetable_increatetable(create_table_container) {
  tabcontainer = document.querySelector('#create_table_tab');
  tabs = tabcontainer.children;
  Array.from(tabs).forEach(element => {
     if(element.id == last_tab_create_table) {
       const correspondingTabDisplay = document.querySelector(`#tab_display[tabnumber="${element.id}"]`);
       correspondingTabDisplay.remove();
       element.remove();
     }
  })
  updateTabNumbers();
  const tabtoclick = tabcontainer.children[0]
  tabtoclick.style.marginLeft = '0';
  if(tabtoclick && tabtoclick.tagName.toLowerCase() !== 'button') {
    tabtoclick.click();
  }
  number_of_tabs = tabcontainer.querySelectorAll('div').length;
  if(number_of_tabs == 1) {
    document.querySelector('.create_table_delete_button').style.display = 'none';
  }
}

function updateTabNumbers() {
  const tabContainer = document.querySelector('#create_table_tab');
  const tabs = tabContainer.querySelectorAll('div:not(.add-button)');
  
  tabs.forEach((tab, index) => {
    const newTabNumber = index + 1;
    const correspondingTabDisplay = document.querySelector(`#tab_display[tabnumber="${tab.id}"]`);
    if (correspondingTabDisplay) {
        correspondingTabDisplay.setAttribute('tabnumber', newTabNumber);
    }
    tab.id = newTabNumber;
    tab.textContent = `Tabela ${newTabNumber}`;
  });
}

function createtabletablistener() {
  const tabcontainer = document.querySelector('#create_table_tab');
  Array.from(tabcontainer.children).forEach(element => {
    if (element.tagName != 'BUTTON') {
        element.addEventListener('mouseover', function() {
            if (element.id != last_tab_create_table) {
                element.style.backgroundColor = 'rgba(87, 48, 129, 1)';
            }
        });

        element.addEventListener('click', function() {
            element.style.backgroundColor = '#e0463a';
            Array.from(tabcontainer.children).forEach(element2 => {
                if (element2.id != element.id && element2.tagName != 'BUTTON') {
                    element2.style.backgroundColor = 'rgba(87, 48, 129, 0.8)';
                }
            });
            allDOMelements = document.querySelectorAll('#tab_display');
            allDOMelements.forEach(e => {
              e.style.display = 'none';
            })
            allDOMelements.forEach(e => {
              tabnumber = e.getAttribute('tabnumber');
              if(element.id == tabnumber) {
                e.style.display = 'flex';
              }
            })
            last_tab_create_table = element.id;
            const tabDisplays = document.querySelectorAll('#tab_display');
            tabDisplays.forEach(function(tab) {
                if (getComputedStyle(tab).display === 'flex') {
                    document.querySelector('.create-table-name').value = tab.getAttribute('tablename');
                }
            });
            
        });

        element.addEventListener('mouseout', function() {
            if (element.id != last_tab_create_table) {
                element.style.backgroundColor = 'rgba(87, 48, 129, 0.8)';
            }
        });
    }
});
} 

function tablistener() {
  Array.from(document.querySelector('.tab_container').children).forEach(element => {
      
      element.addEventListener('mouseover', function() {
          if (element.id != last_tab) {
              element.style.backgroundColor = 'rgba(87, 48, 129, 1)';
          }
      });

      element.addEventListener('click', function() {
       
          if (element.id != last_tab) {
              element.style.backgroundColor = '#e0463a';

              let children = Array.from(document.querySelector('.maincontentborder').children);
              children.forEach(child => {
                  child.style.display = 'none';
              });

         
              let childToShow;
              if (element.id == 'consult') {
                  childToShow = document.querySelector('.consultcontainer');
              } else {
                  childToShow = document.querySelector('.resultcontainer');
              }

              if (childToShow) {
                  childToShow.style.display = 'flex';
              }

          
              document.querySelector(`#${last_tab}`).style.backgroundColor = 'rgba(87, 48, 129, 0.8)';
              
        
              last_tab = element.id;
          }
      });

      element.addEventListener('mouseout', function() {
          if (element.id != last_tab) {
              element.style.backgroundColor = 'rgba(87, 48, 129, 0.8)';
          }
      });
  });
}

function removeOperatorByIndex(line, position, father) {
              if (father != null) {
                fatherposition = father.getAttribute('position');
                for (let [index, element] of operators[line][fatherposition].relation.entries()) {
                    if (element == position) {
                        operators[line][fatherposition].relation[index] = null;
                        break;
                    }
                }
            }
            
            for (let son of operators[line][position].relation) {
              if (son && typeof son === 'number') {
                  for (let [index, element] of operators[line].entries()) {
                      if (element != null && element.operatorindex == son) {
                          removeOperatorByIndex(line, index, null);
                      }
                  }
              }
          }

          
          operators[line].splice(position, 1);
          if(operators[line].length == 0){
              operators.splice(line, 1);
              operatorsDOM = document.querySelectorAll('.operator-container');
                operatorsDOM.forEach(element => {
                    elementline = parseInt(element.getAttribute('line'));
                    if(elementline > parseInt(line)) {
                      element.setAttribute('line', elementline - 1);
                    }
                })
          }else {

            try{
              if(operators[line][position - 1] == null || operators[line][position - 1]){
                if(typeof operators[line][position - 1] != 'object' || operators[line][position - 1] == null){
                  operators.splice(line, 1);
                  operatorsDOM = document.querySelectorAll('.operator-container');
                  operatorsDOM.forEach(element => {
                      elementline = parseInt(element.getAttribute('line'));
                      if(elementline > parseInt(line)) {
                        element.setAttribute('line', elementline - 1);
                      }
                  })
                }
            }
            }catch {
              
            }

          }

          operatorspropertieslisteners();
        }
    
document.addEventListener('keydown', function(event) {
          const selectedOperatorSymbol = document.querySelector('.operator-symbol.selected');
          if (event.key === 'Backspace' && selectedOperatorSymbol) {
              const selectedOperatorcontainer = selectedOperatorSymbol.closest('.operator-container');
              let selectedOperatorfather = selectedOperatorcontainer.parentNode;
              while(!selectedOperatorfather.classList.contains('operator-container')) {
                  if(selectedOperatorfather.classList.contains('consult_interface')) {
                      selectedOperatorfather = null;
                      break;
                  } else {
                      selectedOperatorfather = selectedOperatorfather.parentNode;
                  }
              }
              if(selectedOperatorfather != null) {
                  let relationArea;
                  let soncomplexrelation = null;
                  selectedOperatorfather.querySelectorAll(':scope > .relationArea').forEach(element => {
                      soncomplexrelation = element.querySelector('.complex_relation');
                      if(soncomplexrelation && soncomplexrelation.contains(selectedOperatorcontainer)) {
                          relationArea = element;
                      } else {
                          soncomplexrelation = null;
                      }
                  });
                  if (soncomplexrelation) {
                      let relation = document.createElement('input');
                      relation.classList.add('simple_relation');
                      relation.setAttribute('placeholder', 'R');
                      relation.setAttribute('index', parseInt(soncomplexrelation.getAttribute('index')));
                      relationArea.replaceChild(relation, soncomplexrelation);
                  }
              } else {
                  selectedOperatorcontainer.remove();
              }
              removeOperatorByIndex(selectedOperatorcontainer.getAttribute('line'), selectedOperatorcontainer.getAttribute('position'), selectedOperatorfather);
          }
      });

document.addEventListener('mouseover', function(event) {
  if (event.target.classList.contains('operator-symbol')) {
      const operatorContainer = event.target.closest('.operator-container');
      
      
      if (!event.target.classList.contains('selected')) {
          operatorContainer.style.transition = 'border-color 0.3s ease';
          operatorContainer.style.border = '1px solid rgba(87, 48, 129, 0.5)'; 
      }
  }
});

document.addEventListener('mouseout', function(event) {
  if (event.target.classList.contains('operator-symbol')) {
      const operatorContainer = event.target.closest('.operator-container');
      
    
      if (!event.target.classList.contains('selected')) {
          operatorContainer.style.border = '1px solid transparent'; 
      }
  }
});

document.addEventListener('click', function(event) {
  const clickedElement = event.target;
  let operatorSymbol;

  
  if (clickedElement.classList.contains('operator-symbol')) {
      operatorSymbol = clickedElement;
  }

  if (operatorSymbol) {
      const operatorContainer = operatorSymbol.closest('.operator-container');

   
      document.querySelectorAll('.operator-symbol').forEach(symbol => {
          const container = symbol.closest('.operator-container');
          container.style.border = '1px solid transparent'; 
          symbol.classList.remove('selected'); 
      });

      
      operatorContainer.style.border = '1px solid rgba(87, 48, 129, 0.5)'; 
      operatorSymbol.classList.add('selected'); 
  } else {
   
      document.querySelectorAll('.operator-symbol').forEach(symbol => {
          const container = symbol.closest('.operator-container');
          container.style.border = '1px solid transparent'; 
          symbol.classList.remove('selected'); 
      });
  }
});

function createOperatorContainer(operator, line, position) {

  const operatorContainer = document.createElement('div');
  operatorContainer.classList.add('operator-container');

  operatorContainer.setAttribute('line', line);
  operatorContainer.setAttribute('position', position);

  const operatorElement = document.createElement('div');
  operatorElement.setAttribute('class', 'operator-symbol');
  operatorElement.textContent = operator;

  const relationArea = document.createElement('div');
  relationArea.classList.add('relationArea');

  const parenteses_1 = document.createElement('span');
  parenteses_1.textContent = '(';

  const parenteses_2 = document.createElement('span');
  parenteses_2.textContent = ')';

  let relation = document.createElement('input');
  relation.classList.add('simple_relation');
  relation.setAttribute('placeholder', 'R');

  relation.setAttribute('index', 0)

  relationArea.appendChild(parenteses_1);
  relationArea.appendChild(relation);
  relationArea.appendChild(parenteses_2);


  const attributeValueContainer = document.createElement('div');
  let secondrelationArea = null;

      if(operators.length == 0 || operator == "\u2190") {
        operatorContainer.style.marginTop = '1%';
        operatorContainer.style.marginLeft = '1%';
        if(operator == "\u2190") {
          operatorElement.style.marginLeft = '0.2rem';
          operatorElement.style.marginRight = '0.2rem';
        }
      }
      if (['\u03C3', '\u03C0', '\u03C1'].includes(operator)) {
          const input_atributes = document.createElement('input');
          input_atributes.setAttribute('placeholder', 'Atr1: valor, ...');
          input_atributes.setAttribute('class', 'input-atributes');
          attributeValueContainer.setAttribute('class', 'attribute-value-container');
          attributeValueContainer.appendChild(input_atributes);
      } else {
          secondrelationArea = relationArea.cloneNode(true);
          if(operator == "\u2190") {
            variable = secondrelationArea.querySelector('.simple_relation');
            variable.classList.add('variable');
            variable.setAttribute('placeholder', 'Nome da variável');
          }
          if(operator == "⋈θ") {
            operatorElement.textContent = "⋈"
            operatorElement.style.marginLeft = '0.1rem';
            operatorElement.style.marginRight = '0.1rem';
            const input_atributes = document.createElement('input');
            input_atributes.setAttribute('placeholder', 'Atr1: valor, ...');
            input_atributes.setAttribute('class', 'input-atributes');
            attributeValueContainer.setAttribute('class', 'attribute-value-container');
            attributeValueContainer.appendChild(input_atributes);
          }
          relation.setAttribute('index', 1);
          secondrelationArea.querySelector('.simple_relation').setAttribute('index', 0);
          operatorContainer.appendChild(secondrelationArea);
      }
  
  operatorContainer.appendChild(operatorElement);
  operatorContainer.appendChild(attributeValueContainer);
  operatorContainer.appendChild(relationArea);


  return operatorContainer;
}

document.addEventListener('click', function(event) {
  selectedRelation = event.target.closest('.simple_relation');
  if (selectedRelation) {
      click_flag = true;
  }
});

document.addEventListener('input', function(event) {
  if (event.target.classList.contains('simple_relation')) {
    if(event.target.clientWidth < event.target.scrollWidth) {
      adjustInputWidth(event.target, 5);
    }  
  }
});

document.addEventListener('keydown', function(event) {
  if (event.target.classList.contains('simple_relation')) {
      if (event.key === 'Backspace') { 
          const remInPixels = parseFloat(getComputedStyle(document.documentElement).fontSize);
          const minWidthInPixels = 5 * remInPixels;
          if(event.target.clientWidth > minWidthInPixels) {
              adjustInputWidth(event.target, -5);
          }
      }
  }
});

function adjustInputWidth(input, factor) {
  const tempElement = document.createElement('span');
  tempElement.style.visibility = 'hidden';
  tempElement.style.position = 'absolute';
  tempElement.style.whiteSpace = 'pre';
  tempElement.style.fontSize = window.getComputedStyle(input).fontSize;
  tempElement.style.fontFamily = window.getComputedStyle(input).fontFamily;
  tempElement.textContent = input.value || input.placeholder;
  document.body.appendChild(tempElement);

  const remInPixels = parseFloat(getComputedStyle(document.documentElement).fontSize);
  const newWidthInRem = (tempElement.clientWidth + factor) / remInPixels; 

  input.style.width = `${newWidthInRem}rem`;
  document.body.removeChild(tempElement);
}

function addOperator(operator) {
  const newOperator = {
      operator: operator,
      relation: [],
      atributes_values: null,
      operatorindex: null,
  }

  let container;
  if (operators.length > 0 && operator != "\u2190") {
      if (selectedRelation) {
          if(selectedRelation.classList.contains('variable')) {
            alert('Não é possível atribuir uma expressão ao nome da variável');
            return
          }
          let selectedOperator = selectedRelation;
          while (selectedOperator && !selectedOperator.classList.contains('operator-container')) {
            selectedOperator = selectedOperator.parentNode;
          }
          const complex_input = document.createElement('div');
          complex_input.classList.add('complex_relation');
          selectedRelation.parentNode.replaceChild(complex_input, selectedRelation);
          position = parseInt(selectedOperator.getAttribute('position'));
          let newoperatorposition = parseInt(position) + 1;
          index = selectedRelation.getAttribute('index');
          complex_input.setAttribute('index', index);
          line = parseInt(selectedOperator.getAttribute('line'));
          newOperator.operatorindex = newoperatorposition;
          operators[line][position].relation[index] = newoperatorposition;
          complex_input.appendChild(createOperatorContainer(operator, line, newoperatorposition));
          operators[line].push(newOperator);
      }
  } else {
      container = document.querySelector('.consult_interface');
      if(operator == "\u2190") {
        container.appendChild(createOperatorContainer(operator, operators.length, 1));
        operators.push([null, newOperator]);
        
      }else {
        container.appendChild(createOperatorContainer(operator, operators.length, 0));
        operators.push([newOperator]);
      }
  }
   
    operatorspropertieslisteners();
}

function addOperatorInfo() {
  const operatorInfo = {
      "←": "Este operador é usado para atribuição. Este operador serve para atribuir uma consulta a um nome," +
           "que pode ser referenciado como uma relação em consultas futuras.\n\nFormato da operação: Variável ← Operação. \n\nExemplo de uso: " +
           "A ← σ {idade = 30} (Pessoa), π {nome} (A).",

      "σ": "Este operador representa a seleção, que retorna tuplas que satisfazem os valores informados para os atributos na condição da operação.\n\n" +
           "Formato da operação: σ {condição} (Relação)\n\nExemplo de uso: σ {nome = 'Amy'} (Aluno).\n\n" +
           "Formato de condições aceitas:\n1. Atributo = valor\n2. Atributo1 = Valor1 or Atributo2 = Valor2\n" +
           "3. Atributo like 'A%' (correspondência de string)",

      "Π": "Este operador representa a projeção, que retorna apenas os atributos especificados na condição da operação.\n\n" +
           "Formato da operação: π {Atributos} (Relação)\n\nExemplo de uso: π {preço} (Produto).\n\n" +
           "Formato de condições aceitas: Atributo1, Atributo2...",

      "ρ": "Este é o operador renomear. Este operador permite atribuir novos nomes à relação e/ou seus atributos nas consultas.\n\n" +
           "Formato da operação: ρ {condição} (Relação)\n\n" +
           "Exemplo de uso: ρ {estatura, massa} (Pessoa)\n\n" +
           "Formato de condições aceitas:\n 1. ρ {novo_nome_relação: *} (Relação)\n" +
           "2. ρ {novo_nome_relação: novo_nome_atributo1, novo_nome_atributo2...} (Relação)",

      "⋃": "Este é o operador 'União'. R ∪ M retorna uma instância de relação contendo todas as tuplas que ocorrem na instância de relação R ou na instância de relação M (ou em ambas). R e M devem ser compatíveis à união (número de campos e domínio dos atributos são os mesmos para as duas relações), e o esquema do resultado é definido de forma idêntica ao esquema de R."
         + "\n\n Formato da operação: Relação1 ∪ Relação2\n\nExemplo de uso: Pessoa ∪ Cliente.",
           
      "-": "Este é o operador 'Diferença'. R – M retorna uma instância de relação contendo todas as tuplas que ocorrem em R, mas não em M. As relações R e M devem ser compatíveis à união, e o esquema do resultado é definido de forma idêntica ao esquema de R." +
           "\n\nFormato da operação: Relação1 − Relação2\n\nExemplo de uso: Pessoa − Cliente.",

      "∩": "Este é o operador 'Intersecção'. R ∩ M retorna uma instância de relação contendo todas as tuplas que ocorrem em ambas R e M. As relações R e M devem ser compatíveis à união, e o esquema do resultado é definido de forma idêntica ao esquema de R.\n\n" +
           "Formato da operação: Relação1 ∩ Relação2\n\nExemplo de uso: Pessoa ∩ Cliente.",

      "×": "Este é o operador 'Produto cartesiano'. R × M retorna uma instância de relação cujo esquema contém todos os campos de R (na mesma ordem em que eles aparecem em R) seguidos de todos os campos de M (na mesma ordem em que eles aparecem em M). O resultado de R X M contém uma tupla <r, s> (a concatenação das tuplas r e s) para cada par de tuplas r ∈ R, s ∈ M."
       + "\n\n Formato da operação: Relação1 × Relação2\n\nExemplo de uso: Pessoa × Cliente.",
           
      "⋈": "Este é o operador 'Equijunção'. R ⋈	M é quando a condição de junção consiste apenas em igualdades (ligadas por ∧) no formato R.nome1 = M.nome2, ou seja, igualdades entre os dois campos em R e M.\n\n" +
            "Formato da operação: Relação1 ⋈ Relação2N\nExemplo de uso: Pessoa ⋈ Cliente.",

      "⋈θ": "Este é o operador 'Junção natural'. R ⋈θ	M é uma eqüijunção na qual as igualdades são especificadas para todos os campos que têm os mesmos nomes em R e M. .\n\n" +
            "Formato da operação: Relação1 ⋈θ Condição (Relação2)\n\nExemplo de uso: Pessoa ⋈θ {Pessoa.nome = Cliente.nome} Cliente.\n\n" +
            "Formato de condições aceitas: {Relação1.atributo1 = Relação2.atributo2}",

      "÷": "Considere duas instâncias de rela- ção A e B, na qual A tem (exatamente) dois campos x e y, e B tem apenas um campo y, com o mesmo domínio que A. Definimos a operação divisão A/B como o conjunto de todos os valores x (no formato de tuplas unárias) tais que, para todo valor y em (uma tupla de) B, há uma tupla <x,y> em A."+
       "\n\n Formato da operação: Relação1 ÷ Relação2\n\nExemplo de uso: Pessoa ÷ Cliente."
  };

  const operatorButtons = document.querySelectorAll('.keyboard button');

  operatorButtons.forEach(button => {
      const operator = button.textContent.trim();

      const operatorDescription = operatorInfo[operator] || 'Informação não disponível';

      const existingTooltip = document.querySelector('.tooltip');
      if (existingTooltip) {
          existingTooltip.remove();
      }

      button.addEventListener('mouseenter', () => {
          const tooltip = document.createElement('div');
          tooltip.className = 'tooltip';

          // Converte quebras de linha \n para <br>
          tooltip.innerHTML = operatorDescription.replace(/\n/g, '<br>');

          document.body.appendChild(tooltip);

          const buttonRect = button.getBoundingClientRect();
          tooltip.style.left = `${buttonRect.left}px`;
          tooltip.style.top = `${buttonRect.bottom + window.scrollY + 10}px`; // 10px abaixo do botão

          // Exibe a tooltip
          tooltip.style.visibility = 'visible';
          tooltip.style.opacity = '1';
      });

      button.addEventListener('mouseleave', () => {
          const tooltip = document.querySelector('.tooltip');
          if (tooltip) {
              tooltip.remove(); // Remove a tooltip ao sair do hover
          }
      });
  });
}

document.addEventListener('DOMContentLoaded', addOperatorInfo);

function operatorspropertieslisteners() {
  document.querySelectorAll('.operator-container').forEach((operatorContainer) => {
    let line = parseInt(operatorContainer.getAttribute('line'));

    let position = parseInt(operatorContainer.getAttribute('position'));
    let attributevaluecontainer = operatorContainer.querySelector(':scope > .attribute-value-container');
    let inputAttributes;

    if (attributevaluecontainer) {
      inputAttributes = attributevaluecontainer.querySelector(':scope > .input-atributes');
    }

    let relationAreas = operatorContainer.querySelectorAll(':scope > .relationArea');

    if (inputAttributes && !inputAttributes.getAttribute('listener-added')) {
      inputAttributes.setAttribute('listener-added', 'true');
      inputAttributes.addEventListener('input', () => {
        operators[line][position].atributes_values = inputAttributes.value;
      });
    }

    relationAreas.forEach(relationArea => {
      let simpleRelations = relationArea.querySelectorAll(':scope > .simple_relation');
      if (simpleRelations) {
        simpleRelations.forEach(element => {
          if (!element.getAttribute('listener-added')) {
            element.addEventListener('input', function () {
              let simplerelationindex = element.getAttribute('index');


              let parentElement = element.parentElement;
              while (parentElement && !parentElement.classList.contains('operator-container')) {
                parentElement = parentElement.parentElement;
              }

              if (parentElement) {
                let parentLine = parseInt(parentElement.getAttribute('line'));

                if (element.classList.contains('variable')) {
                  if (operators[parentLine][0] == null) {
                    operators[parentLine][0] = '';
                  }
                  operators[parentLine][0] = element.value;
                }
                operators[parentLine][position].relation[simplerelationindex] = element.value;
              } else {
              }
            });
            element.setAttribute('listener-added', 'true');
          }
        });
      }
    });
  });
}

document.getElementById('consult_form').addEventListener('submit', function(e) {      
  e.preventDefault();
  let result = document.querySelector('#result');
  let historicarea = document.querySelector('#historic');
  let userconsult = document.querySelector('.consult_interface');
  let titlearea = result.querySelector('.titlecontainer');

  let historic_consults = [];
  let historic_results = []; // Certifique-se de que isso esteja definido no escopo adequado

  fetch('/consult', {
      method: 'POST',
      headers: {
          'Content-Type': 'application/json'
      },
      body: JSON.stringify([operators, tablenames])  
  }).then(response => {
      if (!response.ok) {
        return response.json().then(error => { throw new Error(error.error); });
      } else {
          return response.json();
      }
  }).then(data => {
      let last_line_button_container = titlearea.querySelector('.line_button_container');
      if (last_line_button_container) {
          last_line_button_container.remove();
      }

      let line_button_container = document.createElement('div');
      line_button_container.className = 'line_button_container';

      let all_lines_text = [];
      let all_line_results = []; // Novo array para armazenar todos os line_results

      for (let [index, line] of data.entries()) {
          let line_button = document.createElement('BUTTON');
          line_button.className = 'line_button';
          line_button.textContent = `${index + 1}`;
          line_button.title = `Linha ${index + 1} da consulta`;
          line_button_container.appendChild(line_button);
          let buttonoriginalcolor = line_button.style.color;
          let [line_result, line_text] = resultlines(line, result, historicarea, userconsult, titlearea);

          all_line_results.push(line_result); // Armazena cada line_result

          all_lines_text.push(line_text); 

          line_button.onclick = function() {
              Array.from(result.children).forEach(child => {
                  if (child && !child.classList.contains('titlecontainer')) {
                      child.remove();
                  }
              });
              document.querySelectorAll('.line_button').forEach(element => {
                  element.style.backgroundColor = 'rgba(220, 220, 220, 1)';
                  element.style.color = buttonoriginalcolor;
              });
              this.style.backgroundColor = 'rgb(105, 105, 105)';
              this.style.color = 'white';
              result.appendChild(line_result);
              let table = line_result.querySelector('table');
              if (table.scrollWidth < result.clientWidth) {
                  line_result.style.alignItems = 'center';
              }
          };
      }

      const text_query_historic_container = document.createElement('div');
      text_query_historic_container.className = 'text_query_historic_container';

      const search_query_button = document.createElement('BUTTON'); 
      search_query_button.className = 'historic_buttons';
      search_query_button.innerHTML = '<i class="fas fa-play"></i>';
      search_query_button.setAttribute('searchindex', historic_results.length);
      
      const erase_query_button = document.createElement('BUTTON');
      erase_query_button.className = 'historic_buttons';
      erase_query_button.innerHTML = '<i class="fas fa-trash"></i>';
      erase_query_button.setAttribute('searchindex', historic_results.length);

      // Armazena todas as linhas de resultado e o container dos botões das linhas
      historic_results.push([historic_results.length, all_line_results, line_button_container]);

      search_query_button.onclick = function() {
          let searchIndex = parseInt(this.getAttribute('searchindex'));
          let elementToShow = historic_results.find(element => element[0] === searchIndex);

          if (elementToShow) {
              // Limpar resultados atuais
              Array.from(result.children).forEach(child => {
                  if (child && !child.classList.contains('titlecontainer')) {
                      child.remove();
                  }
              });

              // Adicionar todas as linhas de resultado
              elementToShow[1].forEach(lineResult => {
                  result.appendChild(lineResult);
              });

              // Atualizar os botões das linhas
              let existingLineButtons = titlearea.querySelector('.line_button_container');
              if (existingLineButtons) {
                  existingLineButtons.remove();
              }
              titlearea.appendChild(elementToShow[2]);
          }
      };

      erase_query_button.onclick = function() {
          let searchIndex = parseInt(this.getAttribute('searchindex'));
          let elementToRemove = historic_results.find(element => element[0] === searchIndex);
          
          if (elementToRemove) {
              // Remover cada linha de resultado
              elementToRemove[1].forEach(lineResult => {
                  if (result.contains(lineResult)) {
                      lineResult.remove();
                  }
              });

              // Remover o container dos botões das linhas
              if (titlearea.contains(elementToRemove[2])) {
                  elementToRemove[2].remove();
              }

              // Remover o item do histórico
              historic_results = historic_results.filter(element => element[0] !== searchIndex);

              // Remover o elemento do histórico visual
              this.parentNode.parentNode.remove();
          }
      };

      const historic_buttons_container = document.createElement('div');
      historic_buttons_container.className = 'historic_buttons_container';

      const text_query_historic_container_header =  document.createElement('div');
      text_query_historic_container_header.className = 'historic_container_header';
      
      const query_number =  document.createElement('div');
      query_number.className = 'query_number';
      query_number.setAttribute('index', historic_results.length);
      query_number.textContent = `Consulta ${historic_results.length}`;

      const query_date = new Date();
      const query_date_text = query_date.toLocaleString(); 
      const query_date_text_container = document.createElement('div');
      query_date_text_container.className = 'query_date';
      query_date_text_container.textContent = query_date_text;

      historic_buttons_container.appendChild(search_query_button);
      historic_buttons_container.appendChild(erase_query_button);

      text_query_historic_container_header.appendChild(query_number);
      text_query_historic_container_header.appendChild(query_date_text_container);
      
      text_query_historic_container.appendChild(text_query_historic_container_header);

      const resulttab = document.querySelector('.tab_container').querySelector('#results');
      resulttab.click();

      let verticaloverflow = false;
      for (let index = 0; index < all_lines_text.length; index++) {
          const line_text = all_lines_text[index];
          if (index < 2) {
              const container_case_overflow = document.createElement('div');
              container_case_overflow.className = 'container_case_overflow';
              container_case_overflow.appendChild(line_text);
              text_query_historic_container.appendChild(container_case_overflow);
          } else {
              verticaloverflow = true;
              break; 
          }
      }

      Array.from(historicarea.children).forEach(child => {
          if (child && !child.classList.contains('titlecontainer')) {
              historic_consults.push(child);
              child.remove();
          }
      });

      historicarea.appendChild(text_query_historic_container);

      historic_consults.forEach(element => {
          historicarea.appendChild(element);
      });

      titlearea.appendChild(line_button_container);
      search_query_button.click();

      if (verticaloverflow) {
          const verticalelipses = document.createElement('div');
          verticalelipses.className = 'vertical_elipses';
          verticalelipses.textContent = '⋮';
          text_query_historic_container.appendChild(verticalelipses);
      }

      text_query_historic_container.appendChild(historic_buttons_container);
      
      // Seleciona o último botão de linha e clica nele
      let finalbutton = line_button_container.lastElementChild;
      finalbutton.click();

      document.querySelectorAll('.text_query_historic_container').forEach((scrollContainer) => {
          scrollContainer.addEventListener('scroll', function() {
              adjustHeaderAndButtons(scrollContainer);
          });
      });
  }).catch(error => {
      alert(error.message);
  });
});


function adjustHeaderAndButtons(scrollContainer) {
  // Seleciona os containers relacionados ao contêiner de rolagem atual
  const headerContainer = scrollContainer.querySelector('.historic_container_header');
  const buttonsContainer = scrollContainer.querySelector('.historic_buttons_container');

  // Verifica se os containers existem
  if (!headerContainer || !buttonsContainer) {
    console.error("Containers não encontrados.");
    return;
  }

  // Captura a posição de rolagem horizontal
  const scrollLeft = scrollContainer.scrollLeft;

  // Aplica a transformação para mover os elementos junto com a rolagem
  headerContainer.style.transform = `translateX(${scrollLeft}px)`;
  buttonsContainer.style.transform = `translateX(${scrollLeft}px)`;
}

function resultlines(data, result, historicarea, userconsult, titlearea) {
  let newresultarea = document.createElement('div');
  newresultarea.setAttribute('id', 'resultarea');


  let labels = data[0][0];
  let tuples = data[0][1];

  let text_query = document.createElement('div');
  text_query.className = 'text_query';
  text_query.innerHTML = data[1];

  let text_query_display_consult = text_query.cloneNode(true);
  text_query_display_consult.style.width = '100%';
  text_query_display_consult.style.justifyContent = 'center';
  text_query_display_consult.style.marginLeft = '0';
  text_query_display_consult.style.marginBottom = '1rem';
  newresultarea.appendChild(text_query_display_consult);
  

  if(data[0] == 'Nenhuma tupla retornada. Verifique a consulta novamente.') {
    let none_returned =  document.createElement('div');
    none_returned.style.display = 'flex';
    none_returned.style.alignItems = 'center';
    none_returned.style.justifyContent = 'center';
    none_returned.style.textAlign = 'center';
    none_returned.style.width = '100%';
    none_returned.textContent = data[0];
    newresultarea.appendChild(none_returned);
    return [newresultarea, text_query];
  }
  
  let table_tag = document.createElement('table');
  table_tag.style.height = 'fit-content';
  let thead = document.createElement('thead');
  let tbody = document.createElement('tbody');
  let header_row = document.createElement('tr');
  
  for (let attribute_name of labels) {
      let th = document.createElement('th');
      th.textContent = attribute_name;
      header_row.appendChild(th);
  }

  thead.appendChild(header_row);
  table_tag.appendChild(thead);
  table_tag.appendChild(tbody);

  for (let tuple of tuples) {
      let row = document.createElement('tr');
      for (let attribute_value of tuple) {
          let tuplevalue = document.createElement('td');
          tuplevalue.textContent = attribute_value;
          row.appendChild(tuplevalue);
      }
      tbody.appendChild(row);
  }

  newresultarea.appendChild(table_tag);
  return [newresultarea, text_query];
}

function printdbtables(data, requisition) {
          tablenames = [];
          const [tuples, labelsData] = data;

          relations_container = document.querySelector('#bd');
          loadercircle = document.createElement('div');
          loadercircle.className = 'loader_circle'
          
          for(let [index, table] of labelsData.entries()) {
              let table_container_complete;
              let table_container = document.createElement('div');
              table_container.classList.add('table_container');
              
              let table_extension_container = document.createElement('div');
              table_extension_container.classList.add('table_extension_container');
              
              let table_extension_button = document.createElement('BUTTON');
              table_extension_button.classList.add('table_extension_button');
              table_extension_button.title = 'Visualizar tabela completa';
              table_extension_button.textContent = '↗';
              
              table_extension_button.onclick = function() {
                if (table_container_complete) {
                    table_container_complete.style.height = '';
                    table_container_complete.style.width = '';
                    table_container_complete.style.maxWidth = '';
                    table_container_complete.style.maxHeight = '';
                    table_container_complete.style.backgroundColor = '';
                    table_container_complete.style.border = '';
                    table_container_complete.style.paddingRight = '';
                    table_container_complete.style.justifyContent = '';
            
             
                    let table_name = table_container_complete.querySelector('.table_name');
                    if (table_name) {
                        table_name.style.fontSize = ''; 
                        table_name.style.color = '';    
                        table_name.style.backgroundColor = ''; 
                        table_name.style.padding = '';  
                        table_name.style.margin = '';   
                    }
            
                   
                    table_container_complete.querySelectorAll('.show_at_delete_tuple').forEach(child => {
                        child.style.display = 'none';
                    });
            
                    let popup = document.createElement('div');
                    popup.classList.add('complete_table');
                    
                    table_container_complete.style.height = 'fit-content';
                    table_container_complete.style.width = 'fit-content';
                    table_container_complete.style.maxWidth = 'none';
                    table_container_complete.style.maxHeight = 'none';
                    table_container_complete.style.backgroundColor = 'transparent';
                    table_container_complete.style.border = 'none';
                    table_container_complete.style.paddingRight = '0px';
                    table_container_complete.style.justifyContent = 'flex-start';
                    let itens_to_remove = table_container_complete.querySelector('.table_extension_container');
                    if (itens_to_remove) {
                        itens_to_remove.remove();
                    }
                    table_container_complete.querySelectorAll('*').forEach(child => {
                        child.style.opacity = '1';
                    });
                    let circle = table_container_complete.querySelector('.loader_circle');
                    if (circle) {
                        circle.remove();
                    }
                    let close_button = document.createElement('div');
                    close_button.textContent = 'X';
                    close_button.classList.add('close_button');
                    close_button.onclick = function() {
                        document.body.removeChild(this.parentNode.parentNode);
                    };
            
                    let topbar = document.createElement('div');
                    topbar.classList.add('topbarextension');
                    topbar.appendChild(close_button);
                    popup.appendChild(topbar);
                    popup.appendChild(table_container_complete);
                    document.body.appendChild(popup);
            
                    table_container_complete.onscroll = function() {
                        var scrollLeft = table_container_complete.scrollLeft;
                        close_button.style.transform = 'translateX(' + scrollLeft + 'px)';
                    };
                } else {
                    alert('A tabela toda já está sendo mostrada');
                }
            };
            
              
              let table_insert_button = document.createElement('BUTTON');
              table_insert_button.className = 'table_extension_button';
              table_insert_button.title = 'Adicionar tuplas à tabela';
              table_insert_button.textContent = '+';
              
              table_insert_button.onclick = function() {
                  let tablename = this.parentNode.parentNode.querySelector('.table_name').textContent;
                  fetch('/colectinfofromtable', {
                      method: 'POST',
                      body: JSON.stringify({'tablename': tablename, 'type': 'notincludetuples'}),
                      headers: {
                          'Content-Type': 'application/json'
                      }
                  }).then(response => {
                      return response.json();
                  }).then(data => {
                      displaycreatetable(2, createtableclone.cloneNode(true));
                      let container = document.querySelector('#tab_display');
                      container.style.backgroundColor = 'white';
                      container.marginRight = '5.2rem';
                      container.marginBottom = '3rem';
                      container.parentNode.style.border = '0.1rem solid grey';
                      container.setAttribute('tablename', tablename);
                      let attributes = data.attributes;
                      let types = data.types;
                      container.parentNode.querySelector('.close-create-table-container > .create-table-name').value = tablename;
                      let buttonscontainer = container.parentNode.querySelector('.buttons_container_for_table_container');
                      let oldbutton = buttonscontainer.querySelector('.create-db-button');
                      let insertbutton = document.createElement('BUTTON');
                      insertbutton.className = 'create-db-button';
                      insertbutton.innerHTML = '<i class="fas fa-chevron-right icon-arrow" style="margin-right: 5px; color: forestgreen;"></i> Adicionar tuplas';
                      insertbutton.onclick = function() {
                          sendbdtocreate('insert');
                      }
                      buttonscontainer.replaceChild(insertbutton, oldbutton);
                      
                      attributes.forEach((attribute, index) => {
                          let type = types[index];
                          if(type.includes('VARCHAR')) {
                            type = 'TEXT';
                          }
                          if (index === 0) {
                              document.querySelector('.create_atribute_name').value = attribute;
                              const select = document.querySelector('.attribute_type');
                              for (let i = 0; i < select.options.length; i++) {
                                  const option = select.options[i];
                                  if (option.value == type) {
                                      option.selected = true;
                                      break;
                                  }
                              }
                          } else {
                              addAttribute(container, attribute, type);
                          }
                      });
                      attributeinput = container.querySelector('.attribute-input')
                      attributeinput.querySelector('.add-button').style.display = 'none';
                      attributeinput.querySelector('.remove-button').style.display = 'none';
                  }).catch(error => {
                      console.error('Erro ao obter os atributos:', error);
                  });
              }

              let table_delete_button = document.createElement('BUTTON');
              table_delete_button.className = 'table_extension_button';
              table_delete_button.title = 'Deletar tabela';
              table_delete_button.textContent = 'x';
            

              table_delete_button.onclick = function() {
                let container = this.parentNode.parentNode
                let tablename = container.querySelector('.table_name').textContent;

                fetch('/deletetable', {
                  method: 'POST',
                  body: JSON.stringify({'tablename': tablename}),
                  headers: {
                    'Content-Type': 'application/json'
                  }
                }).then((response) => {
                     if(!response.ok) {
                      alert(response)
                     }
                     else {
                         container.remove()
                     }
                })
              }
              let table_update_button = document.createElement('BUTTON');
              table_update_button.className = 'table_extension_button';
              table_update_button.title = 'Atualizar tabela';
              table_update_button.textContent = '↻';
              table_delete_button.style.paddingRight = '1rem !important';
              table_delete_button.style.paddingTop = '0.2rem !important';

              table_update_button.onclick = function() {
                 let tablename = this.parentNode.parentNode.querySelector('.table_name').textContent;
                 fetch('/colectinfofromtable', {
                  method: 'POST',
                  body: JSON.stringify({'tablename': tablename, 'type': 'includetuples'}),
                  headers: {
                      'Content-Type': 'application/json'
                  }}).then(response => {
                      return response.json();
                  }).then(data => { 
                      displaycreatetable(2, createtableclone.cloneNode(true));
                      let container = document.querySelector('#tab_display');
                      container.parentNode.style.border = '0.1rem solid grey';
                      container.setAttribute('tablename', tablename);
                      let attributes = data.attributes;
                      let types = data.types;
                      let tuples = data.tuples;
                      container.parentNode.querySelector('.close-create-table-container > .create-table-name').value = tablename;
                      let buttonscontainer = container.parentNode.querySelector('.buttons_container_for_table_container');
                      let oldbutton = buttonscontainer.querySelector('.create-db-button');
                      let insertbutton = document.createElement('BUTTON');
                      insertbutton.className = 'create-db-button';
                      insertbutton.innerHTML = '<i class="fas fa-chevron-right icon-arrow" style="margin-right: 5px; color: forestgreen;"></i> Atualizar tuplas';
                      insertbutton.onclick = function() {
                          sendbdtocreate('update');
                      }
                      buttonscontainer.replaceChild(insertbutton, oldbutton);
                      const loader_circle = buttonscontainer.querySelector('.create_db_loadercircle');
                      if(loader_circle) {
                        loader_circle.remove();
                      }
                      attributes.forEach((attribute, index) => {
                          let type = types[index];
                          if(type.includes('VARCHAR')) {
                            type = 'TEXT';
                          }
                          let tuplevalue = tuples[0][index]
                          if (index === 0) {
                              document.querySelector('.create_atribute_name').value = attribute;
                              const select = document.querySelector('.attribute_type');
                              document.querySelector('.create_tuple_element').value = tuplevalue;
                              for (let i = 0; i < select.options.length; i++) {
                                  const option = select.options[i];
                                  if (option.value == type) {
                                      option.selected = true;
                                      break;
                                  }
                              }
                          } else {
                              addAttribute(container, attribute, type, tuplevalue);
                          }
                       })

                     tuples.slice(1).forEach(tuple => {
                         addtuple(container, tuple)
                     })

                     container.querySelectorAll('.add-button').forEach(element => {
                      element.style.display = 'none';
                     })
                     container.querySelectorAll('.remove-button').forEach(element => {
                      element.style.display = 'none';
                     })
                })

              }

              let delete_tuple_button = document.createElement('BUTTON');
              delete_tuple_button.className = 'table_extension_button';
              delete_tuple_button.title = 'Remover tuplas da tabela';
              delete_tuple_button.textContent = '-';
              delete_tuple_button.style.fontSize = 'large';

              delete_tuple_button.onclick = function() {
                let tablename = this.parentNode.parentNode.querySelector('.table_name').textContent;
                if(table_container_complete) {
                  table_container_complete = table_container_complete.cloneNode(true)
                  table_container_complete.classList.add('delete_tuple_interface');
                  let popup = document.createElement('div');
                  popup.classList.add('complete_table');
                  table_container_complete.style.height = '100%';
                  table_container_complete.style.width = 'fit-content';
                  table_container_complete.style.maxWidth = 'none';
                  table_container_complete.style.overflow = "hidden";
                  table_container_complete.style.maxHeight = 'none';
                  table_container_complete.style.backgroundColor = 'transparent';
                  table_container_complete.style.border = 'none';
                  table_container_complete.style.paddingRight = '0px';
                  table_container_complete.style.justifyContent = 'flex-start';
                  let close_button = document.createElement('div');
                  close_button.textContent = 'X';
                  close_button.classList.add('close_button');
                  table_container_complete.querySelectorAll('*').forEach(child => {
                    child.style.opacity = '1'    
                  })
                  let circle = table_container_complete.querySelector('.loader_circle')
                  if(circle) {
                    circle.remove();
                  }
                  close_button.onclick = function() {
                      document.body.removeChild(this.parentNode.parentNode);
                  }
                  
                  let topbar = document.createElement('div');
                  topbar.classList.add('topbarextension');

                  let remove_tuple_action_container =  document.createElement('div');
                  remove_tuple_action_container.className = 'remove_tuple_action_container';
                  let remove_tuple_action_button =  document.createElement('BUTTON');
                  remove_tuple_action_button.className = 'create-db-button';
                  let icon = document.createElement('i');
                  icon.className = 'fas fa-trash icon-trash';
                  icon.style.marginRight = '0.5rem';
                  icon.style.marginBottom = '0.2rem';
                  icon.style.color = 'red';
                  remove_tuple_action_button.style.top = '0'
                  remove_tuple_action_button.style.bottom = '0'
                  remove_tuple_action_button.style.width = 'fit-content'
                  remove_tuple_action_button.appendChild(icon);
                  remove_tuple_action_button.appendChild(document.createTextNode('Deletar Tuplas'));
                  remove_tuple_action_button.style.position = 'relative';

                  remove_tuple_action_button.onclick = function() {
                    sendbdtocreate('deletetuple')

                  }  
                  remove_tuple_action_container.appendChild(remove_tuple_action_button);
                  table_container_complete.querySelectorAll('.show_at_delete_tuple').forEach((element, index) => {
                    element.style.display = 'flex';
                    element.style.alignItems = 'center';
                    element.style.border = 'none'; 
                    element.style.justifyContent = 'center';
                    element.style.backgroundColor = 'transparent';
                });
                  
                  topbar.appendChild(close_button);
                  popup.appendChild(topbar);
                  popup.appendChild(table_container_complete);
                  popup.appendChild(remove_tuple_action_container);
                  document.body.appendChild(popup);
                  let size = 0;
                  size = table_container_complete.querySelector('.show_at_delete_tuple').clientWidth;
               
                  contenttopush = table_container_complete.querySelector('.table_name');
                  contenttopush.style.marginLeft = size + 'px';
                  
                  table_container_complete.onscroll = function() {
                      var scrollLeft = table_container_complete.scrollLeft;
                      close_button.style.transform = 'translateX(' + scrollLeft + 'px)';
                  }
                }

              }
              
              table_extension_container.appendChild(table_extension_button);
              table_extension_container.appendChild(table_insert_button);
              table_extension_container.appendChild(delete_tuple_button);
              table_extension_container.appendChild(table_update_button);
              table_extension_container.appendChild(table_delete_button);
             
              
              let table_name = document.createElement('div');
              table_name.classList.add('table_name');
              let table_tag = document.createElement('table');
              let thead = document.createElement('thead');
              let tbody = document.createElement('tbody');

              table_name.textContent = table[0];
              tablenames.push(table[0]);
              table_container.appendChild(table_extension_container);
              table_container.appendChild(table_name);

              let header_row = document.createElement('tr');
              let checkboxattribute = document.createElement('th');
              checkboxattribute.textContent = 'Selecione';
              checkboxattribute.style.display = 'none';
              checkboxattribute.classList.add('show_at_delete_tuple');

              header_row.appendChild(checkboxattribute);
            
              for (let attribute_name of table.slice(1)) {
                let th = document.createElement('th');
                th.textContent = attribute_name;
                header_row.appendChild(th);
              }

              thead.appendChild(header_row);
              table_tag.appendChild(thead);
              table_tag.appendChild(tbody);
              
              table_container.appendChild(table_tag);
              
              if(['insert', 'update', 'deletetuple'].includes(requisition)) {
                  relations_container.querySelectorAll('.table_container').forEach(element => {
                      let name = element.querySelector('.table_name').textContent;
                      if(name == table[0]) {
                          relations_container.replaceChild(table_container, element);
                          let children = table_container.children;
                          for (let i = 0; i < children.length; i++) {
                              if (children[i] !== loadercircle) {
                                  children[i].style.opacity = '0.05';
                              }
                          }
                          table_container.appendChild(loadercircle)
                      }
                  });
              } else {
                  relations_container.appendChild(table_container);
              }
              
              table_container.onscroll = function() {
                  var scrollLeft = table_container.scrollLeft;
                  let buttons = table_container.querySelectorAll('button');
                  buttons.forEach((button) => {
                      button.style.transform = 'translateX(' + scrollLeft + 'px)';
                  });
              }
              
              let count = 0;
              let checkbox = document.createElement('input');
              checkbox.className = 'delete_tuple_checkbox';
              checkbox.type = 'checkbox';
  
              for(let tuple of tuples[index]) {
                  let row = document.createElement('tr');
                  let checkboxTd = document.createElement('td');
                  checkboxTd.style.display = 'none';
                  checkboxTd.appendChild(checkbox.cloneNode(true));
                  checkboxTd.classList.add('show_at_delete_tuple');
                  row.appendChild(checkboxTd)

                  if(tuple.some(item => item.includes('tuples returned') || item.includes('tuple returned'))) {
                      break;
                  }
                  if(count < 3) {
                      for(let [index_value, value] of tuple.entries()) {
                          let tuplevalue = document.createElement('td');
                          tuplevalue.textContent = value;
                          row.appendChild(tuplevalue);
                      }
                      tbody.appendChild(row)
                      table_container_complete = table_container.cloneNode(true);
                  }
                  if(count == 2) {
                      let elipses = document.createElement('p');
                      elipses.textContent = '⋮';
                      elipses.style.width = '5px';
                      elipses.style.height = '3px';
                      if(['insert', 'update', 'deletetuple'].includes(requisition)) {
                        elipses.style.opacity = '0.05'
                      }
                      table_container_complete = table_container.cloneNode(true);
                      table_container.appendChild(elipses);
                  }
                  if(count >= 3) {
                      for(let [index_value, value] of tuple.entries()) {
                          let tuplevalue = document.createElement('td')
                          tuplevalue.textContent = value;
                          row.appendChild(tuplevalue)
                      }
                      table_container_complete.querySelector('tbody').appendChild(row);
                  }
                  count++;
              }

              table_container_complete.querySelector('.table_extension_container').remove();
              
              if(['insert', 'update', 'deletetuple'].includes(requisition)) {
                setTimeout(() => {
                  table_container.removeChild(loadercircle);
                  let children = table_container.children;
                  for (let i = 0; i < children.length; i++) {
                      if (children[i] !== loadercircle) {
                          children[i].style.opacity = '1';
                      }
                  }
                }, 1000)
              }
          }
          return 'ok';
      }
      
function sendbdtocreate(route) {
    
        let db = {};
        const loadercircle = document.createElement('div');
        loadercircle.className = 'create_db_loadercircle';
        if(`${route}` != 'deletetuple') {
        
            let count = 1;
            let tables = document.querySelectorAll('#tab_display');
            const container = tables[0].parentNode.querySelector('.buttons_container_for_table_container');
            container.insertBefore(loadercircle, container.firstChild);
            try {
              tables.forEach(table => {
                  let tablename = table.getAttribute('tablename');
                  let attributes = [];
                  let types = [];
                  let tuples = [];
          
                  table.querySelectorAll('.create_atribute_name').forEach(atributename => {
                      if(atributename.value === '') {
                          throw new Error(`Existem nomes de atributos vazios na tabela: ${table.getAttribute('tabnumber')}`);
                      }
                      attributes.push(atributename.value);
                  });
          
                  table.querySelectorAll('.attribute_type').forEach(type => {
                      if(type.value === 'none') {
                          throw new Error(`Existem tipos de atributos não selecionados na tabela: ${table.getAttribute('tabnumber')}`);
                      }
                      types.push(type.value);
                  });

                  if(tablename == '') {
                    throw new Error(`A tabela: ${table.getAttribute('tabnumber')} precisa de um nome!`);
                  }
          
                  let tupleDOM = table.querySelectorAll('.tuple_input');
                  tupleDOM.forEach(tuple => {
                      let array = [];
                      tuple.querySelectorAll('.create_tuple_element').forEach((cellvalue, index) => {
                          if(cellvalue.value === '') {
                              throw new Error(`Existem valores de atributos vazios na tabela: ${table.getAttribute('tabnumber')}`);
                          }
                      
                          if(types[index] === 'INT' && !/^\d+$/.test(cellvalue.value)) {
                              throw new Error(`O valor do atributo "${attributes[index]}" na tabela ${table.getAttribute('tabnumber')} precisa ser um número.`);
                          }
                          array.push(cellvalue.value); 
                      });
                      tuples.push(array);
                  });
                 
                  db[count] = {
                      tablename: tablename,
                      attributes: attributes,
                      types: types,
                      tuples: tuples
                  };
               
                  count = count + 1;
                  
              });
          } catch (e) {
              return alert(e.message);
          } 
            fetch(`/${route}`, {
              method: 'POST',
              body: JSON.stringify(db),
              headers: {
                'Content-Type': 'application/json' 
              }
            }).then(response => {
              if (!response.ok) {
                  return response.json().then(error => {
                    document.querySelector('.create_db_loadercircle').remove();
                    throw new Error(error.error);  
                })
              } else {
                   deletecreatetable(document.querySelector('#create_table_container'))
                   return response.json()
                  }
            }).then( db => {
              if(['insert', 'update'].includes(`${route}`)) {
                printdbtables(db, `${route}`)
              }else {
                l = document.querySelector('.create_db_loadercircle');
                if(l) {
                   l.remove();
                }
                initializesystem(db)
              }
            }).catch(error => {
              alert(error.message);  
             });
            } else {
              const delete_tuple_interface = document.querySelector('.delete_tuple_interface');
              const buttoncontainer = delete_tuple_interface.parentNode.querySelector('.remove_tuple_action_container');
              const deletebutton = buttoncontainer.querySelector('.create-db-button');
              buttoncontainer.insertBefore(loadercircle, deletebutton);
              const tablename = delete_tuple_interface.querySelector('.table_name').textContent.trim();
              let attributes = [];
              
              const tuples_to_delete = Array.from(delete_tuple_interface.querySelectorAll('tr')).map((element, index) => {
                if (index === 0) {
                  attributes = Array.from(element.querySelectorAll('th')).slice(1).map(attributevalue => {
                    return attributevalue.textContent.split(':')[0].trim();
                  });
                  return null; 
                } else {
                  const checkboxmarked = element.querySelector('td > input[type="checkbox"]:checked');
                  if (checkboxmarked) {
                    const tuple_values = Array.from(element.querySelectorAll('td')).slice(1).map((value, index) => {
                      return [attributes[index], value.textContent.trim()];
                    });
                    return tuple_values;
                  }
                }
                return null;
              }).filter(item => item !== null);
              
              db = {
                tablename: tablename,
                tuples_to_delete: tuples_to_delete
              };
    
              fetch(`/${route}`, {
                method: 'POST',
                body: JSON.stringify(db),
                headers: {
                  'Content-Type': 'application/json' 
                }
              }).then(response => {
                if (!response.ok) {
                  throw new Error('Erro na requisição');
                } else {
                  document.body.removeChild(document.querySelector('.complete_table'))
                  loadercircle.remove();
                  return response.json()
                 }
              }).then(db => {
                printdbtables(db, `${route}`)
              })
            }
          }
      
function pegar() {
  console.log(operators)
}

function operator_impression(operator) {
            if(click_flag == true || operators.length == 0 || operator == "\u2190") {
                click_flag = false
                addOperator(operator);
            }
        }

function tablenamelistener() {

  document.querySelector('.create-table-name').addEventListener('input', function(event) {
    const inputValue = event.target.value;
    const tabDisplays = document.querySelectorAll('#tab_display');
    tabDisplays.forEach(function(tab) {
        if (getComputedStyle(tab).display === 'flex') {
            tab.setAttribute('tablename', inputValue);
        }
    });
});
}

window.addEventListener('beforeunload', function (e) {
  navigator.sendBeacon('/logout'); 
});
</script>
</body>
</html>
