<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/prototipohome.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <title>Document</title>
</head>
<body>
  <div class="maincontainer">
    <div class="topbar">
      <h3>Logo</h3>
      <button id="menubutton">
          <div class="menuelement"></div>
          <div class="menuelement"></div>
          <div class="menuelement"></div>
      </button>
    </div>
    <div class="tab_container">
      <div id="consult">Consulta</div>
      <div id="results">Resultados</div>
    </div>
    <div class="maincontentborder">
      <div class="contentcontainer">
        <img src="../static/images/Logo.png" id="logo">
        <h2>Algebra relacional online</h2>
        <form class="userchoicecontainer">
          <input type="file" id="fileInput" accept=".db">
          <button onclick="displaycreatetable(1)">Criar tabela</button>
          <button type="submit">Entrar</button>
          <button>Saiba mais sobre o projeto</button>
        </form>
      </div>
    </div>
  </div>
    <div class="saibamais">
        <div id="create_table_container">
          <div id="tab_display" tabnumber = 1>
            <button id="close-create-table" onclick="deletecreatetable(this.parentNode.parentNode)">X</button>
            <input type="text" class="create-table-name" placeholder="Nome da tabela">
            <div class="attribute-input">
                <input type="text" placeholder="Nome do Atributo" class="create_atribute_name">
                <select class="attribute_type">
                    <option selected disabled>Tipo</option>
                    <option value="TEXT">Texto</option>
                    <option value="INT">Número</option>
                    <option value="DATE">Data</option>
                </select>
                <button class="add-button" onclick="addAttribute(this.parentNode.parentNode)">+</button>
            </div>
          <div class="tuple_input">
            <button class="add-button" onclick="addtuple(this.parentNode.parentNode)">+</button>
            <input class="create_tuple_element" placeholder="Digite o valor">
          </div>
          <button class="create-db-button" onclick="sendbdtocreate('createdbfile')">
            <i class="fas fa-play" style="margin-right: 1rem;"></i>Criar BD
          </button>
          </div>
      </div>
      </div>
      <div id="bd">
      </div>
      <div class="consult_environment">
        <div class="keyboard">
          <button onclick='operator_impression("\u2190")'>&#8592;</button>
          <button onclick='operator_impression("\u03C3")'>&sigma;</button>
          <button onclick='operator_impression("\u03C0")'>&Pi;</button>
          <button onclick='operator_impression("\u03C1")'>&rho;</button>
          <button onclick='operator_impression("\u222A")'>&Union;</button>
          <button onclick='operator_impression("\u2212")'>-</button>
          <button onclick='operator_impression("\u2229")'>∩</button>
          <button onclick='operator_impression("\u2715")'>×</button>
          <button onclick='operator_impression("⋈")'>⋈</button>
          <button onclick='operator_impression("⋈θ")'>⋈θ</button>
          <button onclick='operator_impression("\u00F7")'>÷</button>
      </div>
      <form method="post" id="consult_form">
          <div class="consult_interface"></div>
          <div class="consultform_buttons_container">
            <button onclick="deletealloperators()"  type="button">
              <i class="fas fa-play" style="margin-right: 0.8rem; color: white;"></i>Apagar
            </button>
            <button type="submit">
              <i class="fas fa-play" style="margin-right: 0.8rem; color: white;"></i>Consultar
            </button>
          </div>
      </form>
      </div>
      <div class="resultcontainer">
        <div id="historic">
          <div class="titlecontainer">
            <h2>Histórico</h2>
          </div>
        </div>
        <div id="result">
          <div class="titlecontainer">
            <h2>Resultado</h2>
            <div id="resultarea">
              <div id="label"></div>
              <div id="tuples"></div>
            </div>
          </div>
        </div>
      </div>
  <script>
    const form = document.querySelector('.userchoicecontainer');
    form.addEventListener('submit', handleFileSelection);

function handleFileSelection(event) {
      event.preventDefault();
      const fileInput = document.getElementById('fileInput');
      const selectedFile = fileInput.files[0];

      if (!selectedFile) {
        return;
      }
        let formData = new FormData();
        formData.append('file', selectedFile);

        fetch('/loadfile', {
          method: 'POST',
          body: formData
        }).then(response => {
          if (!response.ok) {
              throw new Error('Erro na requisição');
          } else {
               return response.json()
              }
        }).then( db => {
          initializesystem(db)
        }) 
    }

function initializesystem(db) {
      const replacementContainer = document.createElement('div');
      replacementContainer.setAttribute('class', 'consultcontainer');
      const contentContainer = document.querySelector('.contentcontainer');
      const containerborder = document.querySelector('.maincontentborder');
      const consult_environment = document.querySelector('.consult_environment');
      const bd_area = document.querySelector('#bd');
      const resultcontainer = document.querySelector('.resultcontainer')

      contentContainer.classList.add('content-fading-out');
            contentContainer.addEventListener('transitionend', () => {
            containerborder.removeChild(contentContainer);
            bd_area.style.display = 'flex';
            Array.from(bd_area.children).forEach(element => {
              element.style.display = 'flex';
            })
            consult_environment.style.display = 'flex';
            Array.from(consult_environment.children).forEach(element => {
            element.style.display = 'flex';
            })
            replacementContainer.appendChild(bd_area)
            replacementContainer.appendChild(consult_environment)
            containerborder.appendChild(replacementContainer);
            replacementContainer.classList.add('content-fading-in')
            containerborder.style.backgroundColor = 'white';
            containerborder.style.opacity = '95%';
            printdbtables(db, 'alltables')
            let tab = document.querySelector('.tab_container')
            tab.style.display = 'flex'
            Array.from(tab.children).forEach(element => {
              element.style.display = 'flex';
            })
            containerborder.style.borderTopLeftRadius = '0';
            containerborder.appendChild(resultcontainer);
            tablistener()
            });    
    }
    
    let last_tab = "consult";
    let last_tab_create_table = 1;
    let operators = [];
    let selectedOperator = null
    let click_flag = false
    let createtableclone;

document.addEventListener('DOMContentLoaded', () => {
        document.querySelector('#create_table_container').style.display = 'flex'
        createtableclone = document.querySelector('#tab_display').cloneNode(true);
        document.querySelector('#create_table_container').style.display = 'none';
  });

function addAttribute(fathercontainer, namevalue, typevalue, tuplevalue) {
            const attributeNameInput = document.createElement('input');
            attributeNameInput.type = 'text';
            attributeNameInput.placeholder = 'Nome do Atributo';
            attributeNameInput.className = "create_atribute_name"
            attributeNameInput.style.marginLeft = "0px";
            attributeNameInput.style.borderTopLeftRadius = "0px";
            attributeNameInput.style.borderBottomLeftRadius = "0px";
            let input_tuples
            if(!tuplevalue) {
              input_tuples =  fathercontainer.querySelectorAll('.tuple_input');
            }else {
              input_tuples = fathercontainer.querySelector('.tuple_input');
            }
            const attributeTypeSelect = document.createElement('select');
            attributeTypeSelect.className = "attribute_type";
            attributeTypeSelect.options[attributeTypeSelect.options.length] = new Option('Tipo', 'Tipo');
            attributeTypeSelect.options[attributeTypeSelect.options.length] = new Option('Texto', 'TEXT');
            attributeTypeSelect.options[attributeTypeSelect.options.length] = new Option('Número', 'INT');
            attributeTypeSelect.options[attributeTypeSelect.options.length] = new Option('Data', 'DATE');
            if(namevalue) {
              attributeNameInput.value = namevalue
              for(i = 0; i < attributeTypeSelect.length; i++) {
                let option = attributeTypeSelect.options[i]
                if(typevalue == option.value) {
                  option.selected = true;
                  break; 
                }
              }
            }
            const addButton = document.createElement('button');
            addButton.className = 'add-button';
            addButton.innerText = '+';
            container = fathercontainer.querySelector('.attribute-input');
            const selects = container.querySelectorAll('.attribute_type');
            selects[selects.length - 1].style.borderTopRightRadius = '0px';
            selects[selects.length - 1].style.borderBottomRightRadius = '0px';
            container.querySelector('.add-button').remove();
            container.appendChild(attributeNameInput);
            container.appendChild(attributeTypeSelect);
            container.appendChild(addButton);

            if(!tuplevalue) {
              input_tuples.forEach((element) => {
                let newvaluetuple =  document.createElement('input');
                newvaluetuple.className = "create_tuple_element";
                newvaluetuple.style.borderTopLeftRadius = '0px';
                newvaluetuple.style.borderBottomLeftRadius = '0px';
                newvaluetuple.placeholder = 'Digite o valor';
                lastchild = element.querySelector('.create_tuple_element:last-child');
                lastchild.style.borderBottomRightRadius = '0px';
                lastchild.style.borderTopRightRadius = '0px';
                element.appendChild(newvaluetuple)
              })
            }else {
                let newvaluetuple =  document.createElement('input');
                newvaluetuple.className = "create_tuple_element";
                newvaluetuple.style.borderTopLeftRadius = '0px';
                newvaluetuple.style.borderBottomLeftRadius = '0px';
                newvaluetuple.value = tuplevalue;
                lastchild = input_tuples.querySelector('.create_tuple_element:last-child');
                lastchild.style.borderBottomRightRadius = '0px';
                lastchild.style.borderTopRightRadius = '0px';
                input_tuples.appendChild(newvaluetuple)    
            }
            
            addButton.onclick = function() {
                addAttribute(fathercontainer);
            };

        }

function addtuple(container, values) {
    const allTupleInputs = container.querySelectorAll('.tuple_input');
    const lastTupleInput = allTupleInputs[allTupleInputs.length - 1];
    const addButton = lastTupleInput.querySelector('.add-button');

    if (addButton) {
        addButton.remove();
    }
    lastTupleInput.style.paddingLeft = '4.2%';
    const quantityofvalues = container.querySelector('.tuple_input').querySelectorAll('.create_tuple_element').length;
    const element = document.createElement('div');
    element.className = 'tuple_input';

    const button = document.createElement('button');
    button.textContent = '+';
    button.className = "add-button";
    button.onclick = function() {
      addtuple(container)
    };
    element.appendChild(button);

    for (let i = 0; i < quantityofvalues; i++) {
        let newvaluetuple = document.createElement('input');
        newvaluetuple.className = "create_tuple_element";
        newvaluetuple.placeholder = 'Digite o valor';
        if(values) {
          newvaluetuple.value = values[i]
        }
        if (quantityofvalues != 1) {
            if (i == 0) {
                newvaluetuple.style.borderTopRightRadius = '0px';
                newvaluetuple.style.borderBottomRightRadius = '0px';
                newvaluetuple.style.borderTopLeftRadius = '5px';
                newvaluetuple.style.borderBottomLeftRadius = '5px';
            } else if (i == quantityofvalues - 1) {
                newvaluetuple.style.borderTopLeftRadius = '0px';
                newvaluetuple.style.borderBottomLeftRadius = '0px';
                newvaluetuple.style.borderTopRightRadius = '5px';
                newvaluetuple.style.borderBottomRightRadius = '5px';
            } else {
                newvaluetuple.style.borderRadius = '0px';
            }
        }
        element.appendChild(newvaluetuple);
    }

    container.appendChild(element);
}

function deletecreatetable(createtable) {
   let table_tab = document.querySelector('#create_table_tab')
   if(table_tab) {
        table_tab.remove()
   }
   createtable.style.display = 'none';
}

function deletealloperators() {
  document.querySelectorAll('.operator-container').forEach(element => {
      element.remove();
  });
  operators = [];
}

function displaycreatetable(requisitiontype, clone) {
    
    const maincontainer = document.querySelector('#create_table_container');
    maincontainer.style.display = 'flex';

    if(clone) {
      let tabdisplay = maincontainer.querySelector('#tab_display')
      maincontainer.replaceChild(clone, tabdisplay)
    }
    if(requisitiontype == 1) {
    let numtabelas = 1;
    let tabcontainer = document.createElement('div');
    tabcontainer.className = 'tab_container';
    tabcontainer.style.display = 'flex';
    tabcontainer.style.top = '18%';
    tabcontainer.style.left = '20%';
    tabcontainer.style.width = '60%';
    tabcontainer.id = 'create_table_tab';

    let tab = document.createElement('div');
    tab.textContent = `Tabela ${numtabelas}`;
    tab.style.backgroundColor = '#f9f9f9';
    tab.style.display = 'flex';
    tab.id = numtabelas;

    let addbutton = document.createElement('BUTTON');
    addbutton.className = 'add-button';
    addbutton.textContent = '+';
    addbutton.style.color = 'black';
    addbutton.style.fontSize = 'larger';
    addbutton.style.alignSelf = 'center';
    addbutton.style.marginBottom = '2.5%';
    addbutton.style.marginLeft = '1.5%';
    addbutton.style.padding = '0.9% 1.3%';
    addbutton.style.backgroundColor = 'rgb(255, 215, 0)';
    
    addbutton.addEventListener('mouseover', () => {
        addbutton.style.backgroundColor = 'rgba(255, 215, 0, 0.8)';
    });
    addbutton.addEventListener('mouseout', () => {
        addbutton.style.backgroundColor = 'rgb(255, 215, 1)';
    });
    addbutton.onclick = function() {
        tabcontainer.querySelector('.add-button').remove();
        let newtab = tab.cloneNode(true);
        numtabelas = numtabelas + 1;
        newtab.textContent = `Tabela ${numtabelas}`;
        newtab.style.borderTopLeftRadius = '0px';
        newtab.style.borderBottomLeftRadius = '0px';
        newtab.id = numtabelas;
        newtab.style.backgroundColor = 'rgba(244, 242, 247, 0.8)';
        tabcontainer.appendChild(newtab);
        tabcontainer.appendChild(addbutton);
        let newtabDOM = createtableclone.cloneNode(true);
        newtabDOM.setAttribute('tabnumber', `${numtabelas}`);
        newtabDOM.style.display = 'none';
        maincontainer.appendChild(newtabDOM);
        createtabletablistener();
    };

    tabcontainer.appendChild(tab);
    tabcontainer.appendChild(addbutton);
    document.querySelector('.maincontainer').appendChild(tabcontainer);
    createtabletablistener();
    }
    
}

function createtabletablistener() {
  const tabcontainer = document.querySelector('#create_table_tab');
  Array.from(tabcontainer.children).forEach(element => {
    if (element.tagName != 'BUTTON') {
        element.addEventListener('mouseover', function() {
            if (element.id != last_tab_create_table) {
                element.style.backgroundColor = 'rgba(244, 242, 247, 0.9)';
            }
        });

        element.addEventListener('click', function() {
            element.style.backgroundColor = '#f9f9f9';
            Array.from(tabcontainer.children).forEach(element2 => {
                if (element2.id != element.id && element2.tagName != 'BUTTON') {
                    element2.style.backgroundColor = 'rgba(244, 242, 247, 0.8)';
                }
            });
            allDOMelements = document.querySelectorAll('#tab_display');
            allDOMelements.forEach(e => {
              e.style.display = 'none';
            })
            allDOMelements.forEach(e => {
              tabnumber = e.getAttribute('tabnumber');
              if(element.id == tabnumber) {
                e.style.display = 'flex';
              }
            })
            last_tab_create_table = element.id;
        });

        element.addEventListener('mouseout', function() {
            if (element.id != last_tab_create_table) {
                element.style.backgroundColor = 'rgba(244, 242, 247, 0.8)';
            }
        });
    }
});
} 

function tablistener() {
      Array.from(document.querySelector('.tab_container').children).forEach(element => {
      
       element.addEventListener('mouseover', function() {
          if(element.id != last_tab) {
            element.style.backgroundColor = 'rgba(244, 242, 247, 0.9)';
          }
       })
      
      element.addEventListener('click', function() {
        element.style.backgroundColor = 'rgba(244, 242, 247, 1)';
    
        let children = Array.from(document.querySelector('.maincontentborder').children);
        
        children.forEach(child => {
            child.style.display = 'none';
        });
        
        let childToShow
        if(element.id == 'consult') {
            childToShow = document.querySelector('.consultcontainer')
        }else {
          childToShow = document.querySelector('.resultcontainer')
        }
         
        if (childToShow) {
            childToShow.style.display = 'flex';
        }

        document.querySelector(`#${last_tab}`).style.backgroundColor = 'rgba(244, 242, 247, 0.8)';
        
        last_tab = element.id;
          })

        element.addEventListener('mouseout', function() {
            if(element.id != last_tab) {
                element.style.backgroundColor = 'rgba(244, 242, 247, 0.8)'; 
            }
        })

        })
    }

function removeOperatorByIndex(index) {
            for (let i = 0; i < operators.length; i++) {
                if (operators[i].operatorindex == index) {
                    console.log(operators[i].operatorindex)
                    operators.splice(i, 1);
                    break;
                }
                if(operators[i].relation.includes(index)) {
                    let index_to_remove = operators[i].relation.indexOf(index);
                    if (index_to_remove !== -1) {
                        operators[i].relation.splice(index_to_remove, 1);
                    }
                }
            }
        }

document.addEventListener('keydown', function(event) {
        if (event.key === 'Backspace') {
            const selectedOperatorcontainer = document.querySelector('.operator-container.selected');
            if (selectedOperatorcontainer) {
                removeOperatorByIndex(selectedComplexRelation.getAttribute('index'))
                selectedComplexRelation.remove();
            }
        }
    });

document.addEventListener('click', function(event) {
            const clickedElement = event.target;
            let Operatorcontainer;
            if(clickedElement.classList.contains('operator-container')) {
              Operatorcontainer = clickedElement
            }
            if (Operatorcontainer) {
                document.querySelectorAll('.operator-container').forEach(element => {
                    element.style.border = 'none'
                    element.classList.remove('selected');
                });
                Operatorcontainer.style.setProperty('border', '2px solid purple', 'important');
                Array.from(Operatorcontainer.children).forEach(child => {
                  if(child.classList.contains('complex_relation')) {
                    child.style.borderBottom = '2px solid purple'
                    child.style.borderTop ='2px solid purple'
                    child.style.borderRight = '2px solid purple'
                  }
                })
                Operatorcontainer.classList.add('selected');
            }else {
              document.querySelectorAll('.operator-container').forEach(element => {
                element.style.border = 'none'
                element.classList.remove('selected');
              });
            }
        });

function createOperatorContainer(operator) {
  const operatorContainer = document.createElement('div');
  operatorContainer.classList.add('operator-container');

  const operatorElement = document.createElement('div');
  operatorElement.setAttribute('class', 'operator-symbol');
  operatorElement.textContent = operator;

  const relationArea = document.createElement('div');
  relationArea.classList.add('relationArea');

  const parenteses_1 = document.createElement('span');
  parenteses_1.textContent = '(';

  const parenteses_2 = document.createElement('span');
  parenteses_2.textContent = ')';

  let relation = document.createElement('input');
  relation.classList.add('simple_relation');
  relation.setAttribute('placeholder', 'R');
  relation.setAttribute('owner', (operators.length))
  relation.setAttribute('index', 0)

  relationArea.appendChild(parenteses_1);
  relationArea.appendChild(relation);
  relationArea.appendChild(parenteses_2);


  const attributeValueContainer = document.createElement('div');
  let secondrelationArea = null;

  if (!['⋈θ'].includes(operator)) {
      if(operators.length == 0 || operator == "\u2190") {
        operatorContainer.style.marginTop = '1%';
        operatorContainer.style.marginLeft = '1%';
      }
      if (['\u03C3', '\u03C0', '\u03C1'].includes(operator)) {
          const input_atributes = document.createElement('input');
          input_atributes.setAttribute('placeholder', 'Atr1: valor, ...');
          input_atributes.setAttribute('class', 'input-atributes');
          attributeValueContainer.setAttribute('class', 'attribute-value-container');
          attributeValueContainer.appendChild(input_atributes);
      } else {
          secondrelationArea = relationArea.cloneNode(true);
          relation.setAttribute('index', 1);
          secondrelationArea.querySelector('.simple_relation').setAttribute('index', 0);
          if(operator == "\u2190") {
            relation.classList.add('assignment');
            variable = secondrelationArea.querySelector('.simple_relation');
            variable.classList.add('variable');
            variable.setAttribute('placeholder', 'Nome da variável');
          }
          operatorContainer.appendChild(secondrelationArea);
      }
  } else {
      
  }

  operatorContainer.appendChild(operatorElement);
  operatorContainer.appendChild(attributeValueContainer);
  operatorContainer.appendChild(relationArea);


  return operatorContainer;
}


document.addEventListener('click', function(event) {
  selectedOperator = event.target.closest('.simple_relation');
  if (selectedOperator) {
      click_flag = true;
  }
});

function addOperator(operator) {
  const newOperator = {
      operator: operator,
      relation: [],
      atributes_values: null,
      operatorindex: null,
  }

  let container;

  if (operators.length > 0 && operator != "\u2190") {
      if (selectedOperator) {
          const complex_input = document.createElement('div');
          complex_input.classList.add('complex_relation');
          var complex_relations = Array.from(document.querySelectorAll('.complex_relation'));
          var complex_index = complex_relations.length;
          complex_input.setAttribute('index', complex_index);
          reference = selectedOperator.getAttribute('owner');
          index = selectedOperator.getAttribute('index');
          newOperator.operatorindex = complex_index;
          operators[reference].relation[index] = complex_index;
          selectedOperator.parentNode.replaceChild(complex_input, selectedOperator);
          complex_input.appendChild(createOperatorContainer(operator));
      }
  } else {
      container = document.querySelector('.consult_interface');
      container.appendChild(createOperatorContainer(operator));
  }

  operators.push(newOperator);

  document.querySelectorAll('.operator-container').forEach((operatorContainer, index) => {
      let attributevaluecontainer = operatorContainer.querySelector(':scope > .attribute-value-container');
      let inputAttributes;
      if (attributevaluecontainer) {
          inputAttributes = attributevaluecontainer.querySelector(':scope > .input-atributes');
      }
      let relationAreas = operatorContainer.querySelectorAll(':scope > .relationArea');
      inputAttributes?.addEventListener('input', () => operators[index].atributes_values = inputAttributes.value);
      relationAreas.forEach(relationArea => {
          let simpleRelations = relationArea.querySelectorAll(':scope > .simple_relation');
          if (simpleRelations) {
              simpleRelations.forEach(element => {
                  element.addEventListener('input', function () {
                      simplerelationindex = element.getAttribute('index');
                      operators[index].relation[simplerelationindex] = element.value;
                  });
              });
          }
      });
  });
}

document.getElementById('consult_form').addEventListener('submit', function(e) {
            e.preventDefault();
            let resultarea = document.querySelector('#result');
            let historicarea = document.querySelector('#historic');
            let userconsult = document.querySelector('.consult_interface');

            fetch('/consult', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                  },
                body: JSON.stringify(operators)  
            }).then(
                response => {
                    if (!response.ok) {
                        throw new Error('Erro na requisição');
                    } else {
                        return response.json();
                    }
                }
            ).then(data => {
                let labels = data[0][0]
                let tuples = data[0][1]

                text = document.createElement('div');
                text.className = 'text_query_container'
                text.innerHTML = data[1]
                historicarea.appendChild(text)
                text.style.marginTop = '4rem'
                text.style.marginBottom = '1rem';
                resultarea.appendChild(text)

                let table_tag = document.createElement('table');
                table_tag.style.height = 'fit-content';
                let thead = document.createElement('thead');
                let tbody = document.createElement('tbody');
                let header_row = document.createElement('tr');
                
                for (let attribute_name of labels) {
                    let th = document.createElement('th');
                    th.textContent = attribute_name;
                    header_row.appendChild(th);
                }

                thead.appendChild(header_row);
                table_tag.appendChild(thead);
                table_tag.appendChild(tbody);

                for(tuple of tuples){
                  let row = document.createElement('tr');
                  for(attribute_value of tuple){
                    let tuplevalue = document.createElement('td')
                    tuplevalue.textContent = attribute_value;
                    row.appendChild(tuplevalue)
                  }
                  tbody.appendChild(row)
                }

                resultarea.appendChild(table_tag)

            }).catch(error => {
                console.log(error);
            });
        });


function printdbtables(data, requisition) {
          const [tuples, labelsData] = data;
          relations_container = document.querySelector('#bd');
          loadercircle = document.createElement('div');
          loadercircle.className = 'loader_circle'
          
          for(let [index, table] of labelsData.entries()) {
              let table_container_complete;
              let table_container = document.createElement('div');
              table_container.classList.add('table_container');
              
              let table_extension_container = document.createElement('div');
              table_extension_container.classList.add('table_extension_container');
              
              let table_extension_button = document.createElement('BUTTON');
              table_extension_button.classList.add('table_extension_button');
              table_extension_button.title = 'Visualizar tabela completa';
              table_extension_button.textContent = '↗';
              
              table_extension_button.onclick = function() {
                  if(table_container_complete) {
                    let popup = document.createElement('div');
                    popup.classList.add('complete_table');
                    table_container_complete.style.height = '100%';
                    table_container_complete.style.width = '100%';
                    table_container_complete.style.backgroundColor = 'transparent';
                    table_container_complete.style.border = 'none';
                    table_container_complete.style.paddingRight = '0px';
                    table_container_complete.style.justifyContent = 'flex-start';
                    table_container_complete.style.marginLeft = 0;
                    let itens_to_remove = table_container_complete.querySelector('.table_extension_container');
                    if(itens_to_remove) {
                      itens_to_remove.remove();
                    }
                    table_container_complete.querySelectorAll('*').forEach(child => {
                      child.style.opacity = '1'
                    })
                    let circle = table_container_complete.querySelector('.loader_circle')
                    if(circle) {
                      circle.remove()
                    }
                    let close_button = document.createElement('div');
                    close_button.textContent = 'X';
                    close_button.classList.add('close_button');
                    close_button.onclick = function() {
                        document.body.removeChild(this.parentNode.parentNode);
                    }
                    
                    let topbar = document.createElement('div');
                    topbar.classList.add('topbarextension');
                    topbar.appendChild(close_button);
                    popup.appendChild(topbar);
                    popup.appendChild(table_container_complete);
                    document.body.appendChild(popup);
                    
                    table_container_complete.onscroll = function() {
                        var scrollLeft = table_container_complete.scrollLeft;
                        close_button.style.transform = 'translateX(' + scrollLeft + 'px)';
                    }
                  }else {
                    alert('A tabela toda já está sendo mostrada')
                  }
                 
              }
              
              let table_insert_button = document.createElement('BUTTON');
              table_insert_button.className = 'table_extension_button';
              table_insert_button.title = 'Adicionar tuplas à tabela';
              table_insert_button.textContent = '+';
              
              table_insert_button.onclick = function() {
                  let tablename = this.parentNode.parentNode.querySelector('.table_name').textContent;
                  fetch('/colectinfofromtable', {
                      method: 'POST',
                      body: JSON.stringify({'tablename': tablename, 'type': 'notincludetuples'}),
                      headers: {
                          'Content-Type': 'application/json'
                      }
                  }).then(response => {
                      return response.json();
                  }).then(data => {
                      displaycreatetable(2, createtableclone.cloneNode(true));
                      let container = document.querySelector('#tab_display');
                      let attributes = data.attributes;
                      let types = data.types;
                      container.querySelector('.create-table-name').value = tablename;
                      let oldbutton = container.querySelector('.create-db-button');
                      let insertbutton = document.createElement('BUTTON');
                      insertbutton.className = 'create-db-button';
                      insertbutton.innerHTML = '<i class="fas fa-play" style="margin-right: 5px;"></i> Adicionar tuplas';
                      insertbutton.onclick = function() {
                          sendbdtocreate('insert');
                      }
                      container.replaceChild(insertbutton, oldbutton);
                      
                      attributes.forEach((attribute, index) => {
                          let type = types[index];
                          if (index === 0) {
                              document.querySelector('.create_atribute_name').value = attribute;
                              const select = document.querySelector('.attribute_type');
                              for (let i = 0; i < select.options.length; i++) {
                                  const option = select.options[i];
                                  if (option.value == type) {
                                      option.selected = true;
                                      break;
                                  }
                              }
                          } else {
                              addAttribute(container, attribute, type);
                          }
                      });
                  }).catch(error => {
                      console.error('Erro ao obter os atributos:', error);
                  });
              }

              let table_delete_button = document.createElement('BUTTON');
              table_delete_button.className = 'table_extension_button';
              table_delete_button.title = 'Deletar tabela';
              table_delete_button.textContent = 'x';

              table_delete_button.onclick = function() {
                let container = this.parentNode.parentNode
                let tablename = container.querySelector('.table_name').textContent;

                fetch('/deletetable', {
                  method: 'POST',
                  body: JSON.stringify({'tablename': tablename}),
                  headers: {
                    'Content-Type': 'application/json'
                  }
                }).then((response) => {
                     if(!response.ok) {
                      alert(response)
                     }
                     else {
                         container.remove()
                     }
                })

              }

              let table_update_button = document.createElement('BUTTON');
              table_update_button.className = 'table_extension_button';
              table_update_button.title = 'Atualizar tabela';
              table_update_button.textContent = '↻';

              table_update_button.onclick = function() {
                 let tablename = this.parentNode.parentNode.querySelector('.table_name').textContent;
                 fetch('/colectinfofromtable', {
                  method: 'POST',
                  body: JSON.stringify({'tablename': tablename, 'type': 'includetuples'}),
                  headers: {
                      'Content-Type': 'application/json'
                  }}).then(response => {
                      return response.json();
                  }).then(data => { 
                      displaycreatetable(2, createtableclone.cloneNode(true));
                      let container = document.querySelector('#tab_display');
                      let attributes = data.attributes;
                      let types = data.types;
                      let tuples = data.tuples;
                      container.querySelector('.create-table-name').value = tablename;
                      let oldbutton = container.querySelector('.create-db-button');
                      let insertbutton = document.createElement('BUTTON');
                      insertbutton.className = 'create-db-button';
                      insertbutton.innerHTML = '<i class="fas fa-play" style="margin-right: 5px;"></i> Atualizar tuplas';
                      insertbutton.onclick = function() {
                          sendbdtocreate('update');
                      }
                      container.replaceChild(insertbutton, oldbutton);
                      
                      attributes.forEach((attribute, index) => {
                          let type = types[index];
                          let tuplevalue = tuples[0][index]
                          if (index === 0) {
                              document.querySelector('.create_atribute_name').value = attribute;
                              const select = document.querySelector('.attribute_type');
                              document.querySelector('.create_tuple_element').value = tuplevalue;
                              for (let i = 0; i < select.options.length; i++) {
                                  const option = select.options[i];
                                  if (option.value == type) {
                                      option.selected = true;
                                      break;
                                  }
                              }
                          } else {
                              addAttribute(container, attribute, type, tuplevalue);
                          }
                       })

                     tuples.slice(1).forEach(tuple => {
                         addtuple(container, tuple)
                     })
                })
              }

              let delete_tuple_button = document.createElement('BUTTON');
              delete_tuple_button.className = 'table_extension_button';
              delete_tuple_button.title = 'Remover tuplas da tabela';
              delete_tuple_button.textContent = '-';

              delete_tuple_button.onclick = function() {
                let tablename = this.parentNode.parentNode.querySelector('.table_name').textContent;
                if(table_container_complete) {
                  table_container_complete = table_container_complete.cloneNode(true)
                  table_container_complete.classList.add('delete_tuple_interface');
                  let popup = document.createElement('div');
                  popup.classList.add('complete_table');
                  table_container_complete.style.height = '100%';
                  table_container_complete.style.width = '100%';
                  table_container_complete.style.backgroundColor = 'transparent';
                  table_container_complete.style.border = 'none';
                  table_container_complete.style.paddingRight = '0px';
                  table_container_complete.style.justifyContent = 'flex-start';
                  table_container_complete.style.marginLeft = 0;
                  

                  let close_button = document.createElement('div');
                  close_button.textContent = 'x';
                  close_button.classList.add('close_button');
                  close_button.onclick = function() {
                      document.body.removeChild(this.parentNode.parentNode);
                  }
                  
                  let topbar = document.createElement('div');
                  topbar.classList.add('topbarextension');

                  let remove_tuple_action_container =  document.createElement('div');
                  remove_tuple_action_container.className = 'remove_tuple_action_container';
                  let remove_tuple_action_button =  document.createElement('BUTTON');
                  remove_tuple_action_button.className = 'create-db-button';
                  let icon = document.createElement('i');
                  icon.className = 'fas fa-trash-alt'; 
                  icon.style.marginRight = '5px'; 
                  remove_tuple_action_button.style.top = '0'
                  remove_tuple_action_button.style.bottom = '0'
                  remove_tuple_action_button.style.width = 'fit-content'
                  remove_tuple_action_button.appendChild(icon);
                  remove_tuple_action_button.appendChild(document.createTextNode('Deletar Tuplas'));
                  remove_tuple_action_button.style.position = 'relative';

                  remove_tuple_action_button.onclick = function() {
                    sendbdtocreate('deletetuple')

                  }

                  remove_tuple_action_container.appendChild(remove_tuple_action_button);

                  table_container_complete.querySelectorAll('.show_at_delete_tuple').forEach(element => {
                    element.style.display = 'flex';
                    element.style.alignItems = 'center';
                    element.style.border = 'none'; 
                    element.style.justifyContent = 'center';
                    element.style.backgroundColor = 'transparent';
                });

                  topbar.appendChild(close_button);
                  popup.appendChild(topbar);
                  popup.appendChild(table_container_complete);
                  popup.appendChild(remove_tuple_action_container);
                  document.body.appendChild(popup);
                  
                  table_container_complete.onscroll = function() {
                      var scrollLeft = table_container_complete.scrollLeft;
                      close_button.style.transform = 'translateX(' + scrollLeft + 'px)';
                  }
                }

              }
              
              table_extension_container.appendChild(table_extension_button);
              table_extension_container.appendChild(table_insert_button);
              table_extension_container.appendChild(delete_tuple_button);
              table_extension_container.appendChild(table_update_button);
              table_extension_container.appendChild(table_delete_button);
             
              
              let table_name = document.createElement('div');
              table_name.classList.add('table_name');
              let table_tag = document.createElement('table');
              let thead = document.createElement('thead');
              let tbody = document.createElement('tbody');

              table_name.textContent = table[0];
              table_container.appendChild(table_extension_container);
              table_container.appendChild(table_name);

              let header_row = document.createElement('tr');
              let checkboxattribute = document.createElement('th');
              checkboxattribute.textContent = 'Selecione';
              checkboxattribute.style.display = 'none';
              checkboxattribute.classList.add('show_at_delete_tuple');

              header_row.appendChild(checkboxattribute);
            
              for (let attribute_name of table.slice(1)) {
                let th = document.createElement('th');
                th.textContent = attribute_name;
                header_row.appendChild(th);
              }

              thead.appendChild(header_row);
              table_tag.appendChild(thead);
              table_tag.appendChild(tbody);
              
              table_container.appendChild(table_tag);
              
              if(['insert', 'update', 'deletetuple'].includes(requisition)) {
                  relations_container.querySelectorAll('.table_container').forEach(element => {
                      let name = element.querySelector('.table_name').textContent;
                      if(name == table[0]) {
                          relations_container.replaceChild(table_container, element);
                          let children = table_container.children;
                          for (let i = 0; i < children.length; i++) {
                              if (children[i] !== loadercircle) {
                                  children[i].style.opacity = '0.05';
                              }
                          }
                          table_container.appendChild(loadercircle)
                      }
                  });
              } else {
                  relations_container.appendChild(table_container);
              }
              
              table_container.onscroll = function() {
                  var scrollLeft = table_container.scrollLeft;
                  let buttons = table_container.querySelectorAll('button');
                  buttons.forEach((button) => {
                      button.style.transform = 'translateX(' + scrollLeft + 'px)';
                  });
              }
              
              let count = 0;
              let checkbox = document.createElement('input');
              checkbox.className = 'delete_tuple_checkbox';
              checkbox.type = 'checkbox';
  
              for(let tuple of tuples[index]) {
                  
                  let row = document.createElement('tr');
                  let checkboxTd = document.createElement('td');
                  checkboxTd.style.display = 'none';
                  checkboxTd.appendChild(checkbox.cloneNode(true));
                  checkboxTd.classList.add('show_at_delete_tuple');
                  row.appendChild(checkboxTd)

                  if(tuple.some(item => item.includes('tuples returned') || item.includes('tuple returned'))) {
                      break;
                  }
                  if(count < 3) {
                      for(let [index_value, value] of tuple.entries()) {
                          let tuplevalue = document.createElement('td');
                          tuplevalue.textContent = value;
                          row.appendChild(tuplevalue);
                      }
                      tbody.appendChild(row)
                      table_container_complete = table_container.cloneNode(true);
                  }
                  if(count == 2) {
                      let elipses = document.createElement('p');
                      elipses.textContent = '⋮';
                      elipses.style.width = '5px';
                      elipses.style.height = '3px';
                      if(['insert', 'update', 'deletetuple'].includes(requisition)) {
                        elipses.style.opacity = '0.05'
                      }
                      table_container_complete = table_container.cloneNode(true);
                      table_container.appendChild(elipses);
                  }
                  if(count >= 3) {
                      for(let [index_value, value] of tuple.entries()) {
                          let tuplevalue = document.createElement('td')
                          tuplevalue.textContent = value;
                          row.appendChild(tuplevalue)
                      }
                      table_container_complete.querySelector('tbody').appendChild(row);
                  }
                  count++;
              }

              table_container_complete.querySelector('.table_extension_container').remove();
              
              if(['insert', 'update', 'deletetuple'].includes(requisition)) {
                setTimeout(() => {
                  table_container.removeChild(loadercircle);
                  let children = table_container.children;
                  for (let i = 0; i < children.length; i++) {
                      if (children[i] !== loadercircle) {
                          children[i].style.opacity = '1';
                      }
                  }
                }, 1000)
              }
          }
          return 'ok';
      }
      
function sendbdtocreate(route) {

    let db = {};
   
    if(`${route}` != 'deletetuple') {
        let count = 1;
        let tables = document.querySelectorAll('#tab_display');
        tables.forEach(table => {
        let tablename = table.querySelector('.create-table-name').value;
        let attributes = [];
        let types = [];
        let tuples = [];

        table.querySelectorAll('.create_atribute_name').forEach(atributename => {
            attributes.push(atributename.value);
        });

        table.querySelectorAll('.attribute_type').forEach(type => {
            types.push(type.value);
        });

        let tupleDOM = table.querySelectorAll('.tuple_input');
        tupleDOM.forEach(tuple => {
            let array = [];
            tuple.querySelectorAll('.create_tuple_element').forEach(cellvalue => {
                array.push(cellvalue.value); 
            });
            tuples.push(array);
        });
            db[count] = {
                tablename: tablename,
                attributes: attributes,
                types: types,
                tuples: tuples
            };
            count = count + 1;
        });
        fetch(`/${route}`, {
          method: 'POST',
          body: JSON.stringify(db),
          headers: {
            'Content-Type': 'application/json' 
          }
        }).then(response => {
          if (!response.ok) {
              throw new Error('Erro na requisição');
          } else {
               deletecreatetable(document.querySelector('#create_table_container'))
               return response.json()
              }
        }).then( db => {
          if(['insert', 'update'].includes(`${route}`)) {
            printdbtables(db, `${route}`)
          }else {
            initializesystem(db)
          }
        }) 
        }else {
          const delete_tuple_interface = document.querySelector('.delete_tuple_interface');
          const tablename = delete_tuple_interface.querySelector('.table_name').textContent.trim();
          let attributes = [];
          
          const tuples_to_delete = Array.from(delete_tuple_interface.querySelectorAll('tr')).map((element, index) => {
            if (index === 0) {
              attributes = Array.from(element.querySelectorAll('th')).slice(1).map(attributevalue => {
                return attributevalue.textContent.split(':')[0].trim();
              });
              return null; 
            } else {
              const checkboxmarked = element.querySelector('td > input[type="checkbox"]:checked');
              if (checkboxmarked) {
                const tuple_values = Array.from(element.querySelectorAll('td')).slice(1).map((value, index) => {
                  return [attributes[index], value.textContent.trim()];
                });
                return tuple_values;
              }
            }
            return null;
          }).filter(item => item !== null);
          
          db = {
            tablename: tablename,
            tuples_to_delete: tuples_to_delete
          };

          console.log(db)

          fetch(`/${route}`, {
            method: 'POST',
            body: JSON.stringify(db),
            headers: {
              'Content-Type': 'application/json' 
            }
          }).then(response => {
            if (!response.ok) {
              throw new Error('Erro na requisição');
            }else {
              document.body.removeChild(document.querySelector('.complete_table'))
              return response.json()
             }
          }).then(db => {
            printdbtables(db, `${route}`)
          })
        }
      }     

function operator_impression(operator) {
           
            if(click_flag == true || operators.length == 0 || operator == "\u2190") {
                click_flag = false
                addOperator(operator);
            }
        }

</script>
</body>
</html>
